{"version":3,"sources":["/tools/isobuild/npm-discards.js"],"names":["assert","require","files","_","NpmDiscards","ok","discards","NDp","prototype","merge","into","from","each","fromValue","packageName","intoValue","has","isString","isRegExp","push","isArray","apply","slice","shouldDiscard","candidatePath","isDirectory","lstat","currentPath","parentPath","pathDirname","pathBasename","relPath","pathRelative","pathJoin","pathSep","some","pattern","matches","match","charAt","indexOf","module","exports"],"mappings":"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","file":"tools/isobuild/npm-discards.js.map","sourcesContent":["var assert = require(\"assert\");\nvar files = require('../fs/files.js');\nvar _ = require(\"underscore\");\n\n// This class encapsulates a structured specification of files and\n// directories that should be stripped from the node_modules directories\n// of Meteor packages during `meteor build`, as requested by calling\n// `Npm.discard` in package.js files.\nfunction NpmDiscards() {\n  assert.ok(this instanceof NpmDiscards);\n  this.discards = {};\n}\n\nvar NDp = NpmDiscards.prototype;\n\n// Update the current specification of discarded files with additional\n// patterns that should be discarded. See the comment in package-source.js\n// about `Npm.strip` for an explanation of what should be passed for the\n// `discards` parameter.\nNDp.merge = function(discards) {\n  merge(this.discards, discards);\n};\n\nfunction merge(into, from) {\n  _.each(from, function(fromValue, packageName) {\n    var intoValue = _.has(into, packageName) && into[packageName];\n    if (_.isString(fromValue) ||\n        _.isRegExp(fromValue)) {\n      if (intoValue) {\n        intoValue.push(fromValue);\n      } else {\n        into[packageName] = [fromValue];\n      }\n    } else if (_.isArray(fromValue)) {\n      if (intoValue) {\n        intoValue.push.apply(intoValue, fromValue);\n      } else {\n        // Make a defensive copy of any arrays passed to `Npm.strip`.\n        into[packageName] = fromValue.slice(0);\n      }\n    }\n  });\n}\n\nNDp.shouldDiscard = function shouldDiscard(candidatePath, isDirectory) {\n  if (typeof isDirectory === \"undefined\") {\n    isDirectory = files.lstat(candidatePath).isDirectory();\n  }\n\n  for (var currentPath = candidatePath, parentPath;\n       (parentPath = files.pathDirname(currentPath)) !== currentPath;\n       currentPath = parentPath) {\n    if (files.pathBasename(parentPath) === \"node_modules\") {\n      var packageName = files.pathBasename(currentPath);\n\n      if (_.has(this.discards, packageName)) {\n        var relPath = files.pathRelative(currentPath, candidatePath);\n\n        if (isDirectory) {\n          relPath = files.pathJoin(relPath, files.pathSep);\n        }\n\n        return this.discards[packageName].some(function(pattern) {\n          return matches(pattern, relPath);\n        });\n      }\n\n      // Stop at the first ancestor node_modules directory we find.\n      break;\n    }\n  }\n\n  return false;\n};\n\n// TODO Improve this. For example we don't currently support wildcard\n// string patterns (just use a RegExp if you need that flexibility).\nfunction matches(pattern, relPath) {\n  if (_.isRegExp(pattern)) {\n    return relPath.match(pattern);\n  }\n\n  assert.ok(_.isString(pattern));\n\n  if (pattern.charAt(0) === files.pathSep) {\n    return relPath.indexOf(pattern.slice(1)) === 0;\n  }\n\n  return relPath.indexOf(pattern) !== -1;\n}\n\nmodule.exports = NpmDiscards;\n"]}