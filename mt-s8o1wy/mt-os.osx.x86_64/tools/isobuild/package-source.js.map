{"version":3,"sources":["/tools/isobuild/package-source.js"],"names":["_","require","sourcemap","files","utils","watch","buildmessage","meteorNpm","Builder","archinfo","catalog","packageVersionParser","compiler","Profile","SourceArch","PackageNamespace","PackageNpm","PackageCordova","PackageAPI","TEST_FILENAME_REGEXPS","APP_TEST_FILENAME_REGEXPS","isTestFilePath","convert","convertColonsInPath","optimisticReadFile","optimisticHashOrNull","optimisticStatOrNull","AUTO_TEST_PREFIX","isTestName","name","nameStart","slice","length","genTestName","loadOrderSort","sourceProcessorSet","arch","isTemplate","memoize","filename","classification","classifyFilename","type","sourceProcessors","Error","legacyIsTemplate","a","b","isTemplate_a","pathBasename","isTemplate_b","ismain_a","indexOf","ismain_b","islib_a","pathSep","islib_b","a_parts","split","b_parts","len_a","len_b","i","a_part","b_part","splitConstraint","c","parsed","parsePackageConstraint","constraint","constraintString","getExcerptFromReadme","text","commonmark","reader","DocParser","parse","relevantNodes","any","children","child","isHeader","t","push","isEmpty","textLines","start","start_line","stop","last","end_line","excerpt","join","replace","SymlinkLoopChecker","sourceRoot","_seenPaths","_realpathCache","check","relDir","quietly","absPath","pathJoin","realPath","realpath","e","code","has","error","PackageSource","self","serveRoot","metadata","docsExplicitlyProvided","version","versionExplicitlyProvided","architectures","pluginInfo","pluginWatchSet","WatchSet","npmDependencies","npmDiscards","npmCacheDirectory","cordovaDependencies","testName","isTest","debugOnly","prodOnly","testOnly","includeTool","isCore","extend","prototype","initEmpty","initFromOptions","options","sources","ensureOnlyValidVersions","forCordova","isString","npmDir","map","source","relPath","sourceArch","kind","uses","use","getFiles","localNodeModulesDirs","_checkCrossUnibuildVersionConstraints","initFromPackageDir","dir","assertInCapture","isPortable","initFromPackageDirOptions","documentation","inCheckout","packDir","getCurrentToolsDir","pathDirname","exists","packageFileHashes","Object","create","packageJsPath","packageJsCode","pkgJsonPath","pkgJsonStat","isFile","watchPackageFiles","watchSet","each","hash","path","addFile","Package","Npm","Cordova","runJavaScript","toString","symbols","exception","_fileAndDepLoader","_dependencies","validatePackageName","versionParserError","message","api","buildingIsopackets","markBoundary","console","log","stack","ALL_ARCHES","assets","doNotDepOnSelf","dep","label","implies","releaseRecords","setFromRel","newConstraint","releaseRecord","packages","reduce","x","y","pathResolve","_discards","process","env","NO_METEOR_PACKAGE","alreadyDependsOnMeteor","find","u","unshift","result","relPathToSourceObj","forEach","sourceObj","_findSources","isApp","fileOptions","_inferFileOptions","lazy","declaredExports","exports","_hasTests","_readAndWatchDirectory","include","exclude","names","readAndWatchDirectory","initFromAppDir","projectContext","ignoreFiles","appDir","projectDir","projectConstraintsFile","eachConstraint","projectWatchSet","getProjectWatchSet","platformList","getCordovaPlatforms","findOptions","loopChecker","sort","_findAssets","origAppDir","getOriginalAppDirForTestPackages","origNodeModulesDir","origNodeModulesStat","statOrNull","isDirectory","sourcePath","local","merge","global","testCommandMetadata","isAppTest","isTestFile","dirs","transpile","matches","endsWith","bare","_findSourcesCache","sourceReadOptions","appReadDirectoryOptions","Array","apply","controlFiles","anyLevelExcludes","topLevelExcludes","nodeModulesReadOptions","concat","baseCacheKey","JSON","stringify","excludes","key","value","isRegExp","flags","makeCacheKey","depth","inNodeModules","cacheKey","readOptions","difference","subdirectories","nodeModulesDir","test","subdir","withCache","assetDir","assetDirs","isEqual","shift","substr","assetsAndSubdirs","item","containsPlugins","getDependencyMetadata","ret","_computeDependencyMetadata","logError","getPackagesToLoadFirst","packageMap","processUse","weak","unordered","isIsobuildFeaturePackage","packageInfo","getInfo","info","spec","parsedSpec","keys","getExports","exp","arches","processReadme","assertInJob","fullReadme","readFile","err","errorMessage","contents","sha256","dependencies","allConstraints","failed","implied","skipWeak","skipUnordered","references","d","reference","withoutSpecificOs","partial","constraints","uniq","displayName","module"],"mappings":"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","file":"tools/isobuild/package-source.js.map","sourcesContent":["var _ = require('underscore');\nvar sourcemap = require('source-map');\n\nvar files = require('../fs/files.js');\nvar utils = require('../utils/utils.js');\nvar watch = require('../fs/watch.js');\nvar buildmessage = require('../utils/buildmessage.js');\nvar meteorNpm = require('./meteor-npm.js');\nimport Builder from './builder.js';\nvar archinfo = require('../utils/archinfo.js');\nvar catalog = require('../packaging/catalog/catalog.js');\nvar packageVersionParser = require('../packaging/package-version-parser.js');\nvar compiler = require('./compiler.js');\nvar Profile = require('../tool-env/profile.js').Profile;\n\nimport SourceArch from './source-arch.js';\nimport { PackageNamespace } from \"./package-namespace.js\";\nimport { PackageNpm } from \"./package-npm.js\";\nimport { PackageCordova } from \"./package-cordova.js\";\nimport { PackageAPI } from \"./package-api.js\";\n\nimport {\n  TEST_FILENAME_REGEXPS,\n  APP_TEST_FILENAME_REGEXPS,\n  isTestFilePath } from './test-files.js';\n\nimport {\n  convert as convertColonsInPath\n} from '../utils/colon-converter.js';\n\nimport {\n  optimisticReadFile,\n  optimisticHashOrNull,\n  optimisticStatOrNull,\n} from \"../fs/optimistic.js\";\n\n// XXX: This is a medium-term hack, to avoid having the user set a package name\n// & test-name in package.describe. We will change this in the new control file\n// world in some way.\nvar AUTO_TEST_PREFIX = \"local-test:\";\nvar isTestName = function (name) {\n  var nameStart = name.slice(0, AUTO_TEST_PREFIX.length);\n  return nameStart === AUTO_TEST_PREFIX;\n};\nvar genTestName = function (name) {\n  return AUTO_TEST_PREFIX + name;\n};\n\n// Returns a sort comparator to order files into load order.\nvar loadOrderSort = function (sourceProcessorSet, arch) {\n  const isTemplate = _.memoize((filename) => {\n    const classification = sourceProcessorSet.classifyFilename(filename, arch);\n    switch (classification.type) {\n    case 'extension':\n    case 'filename':\n      if (! classification.sourceProcessors) {\n        // This is *.js, not a template. #HardcodeJs\n        return false;\n      }\n      if (classification.sourceProcessors.length > 1) {\n        throw Error(\"conflicts in compiler?\");\n      }\n      return classification.sourceProcessors[0].isTemplate;\n\n    case 'legacy-handler':\n      return classification.legacyIsTemplate;\n\n    case 'wrong-arch':\n    case 'unmatched':\n      return false;\n\n    default:\n      throw Error(`surprising type ${classification.type} for ${filename}`);\n    }\n  });\n\n  return function (a, b) {\n    // XXX MODERATELY SIZED HACK --\n    // push template files ahead of everything else. this is\n    // important because the user wants to be able to say\n    //   Template.foo.events = { ... }\n    // in a JS file and not have to worry about ordering it\n    // before the corresponding .html file.\n    //\n    // maybe all of the templates should go in one file?\n    var isTemplate_a = isTemplate(files.pathBasename(a));\n    var isTemplate_b = isTemplate(files.pathBasename(b));\n    if (isTemplate_a !== isTemplate_b) {\n      return (isTemplate_a ? -1 : 1);\n    }\n\n    // main.* loaded last\n    var ismain_a = (files.pathBasename(a).indexOf('main.') === 0);\n    var ismain_b = (files.pathBasename(b).indexOf('main.') === 0);\n    if (ismain_a !== ismain_b) {\n      return (ismain_a ? 1 : -1);\n    }\n\n    // /lib/ loaded first\n    var islib_a = (a.indexOf(files.pathSep + 'lib' + files.pathSep) !== -1 ||\n                   a.indexOf('lib' + files.pathSep) === 0);\n    var islib_b = (b.indexOf(files.pathSep + 'lib' + files.pathSep) !== -1 ||\n                   b.indexOf('lib' + files.pathSep) === 0);\n    if (islib_a !== islib_b) {\n      return (islib_a ? -1 : 1);\n    }\n\n    var a_parts = a.split(files.pathSep);\n    var b_parts = b.split(files.pathSep);\n\n    // deeper paths loaded first.\n    var len_a = a_parts.length;\n    var len_b = b_parts.length;\n    if (len_a < len_b) {\n      return 1;\n    }\n    if (len_b < len_a) {\n      return -1;\n    }\n\n    // Otherwise compare path components lexicographically.\n    for (var i = 0; i < len_a; ++i) {\n      var a_part = a_parts[i];\n      var b_part = b_parts[i];\n      if (a_part < b_part) {\n        return -1;\n      }\n      if (b_part < a_part) {\n        return 1;\n      }\n    }\n\n    // Never reached unless there are somehow duplicate paths.\n    return 0;\n  };\n};\n\nvar splitConstraint = function (c) {\n  // XXX print error better (w/ buildmessage?)?\n  var parsed = utils.parsePackageConstraint(c);\n  return { package: parsed.package,\n           constraint: parsed.constraintString || null };\n};\n\n// Given the text of a README.md file, excerpts the text between the first and\n// second heading.\n//\n// Specifically - if there is text between the document name, and the first\n// subheading, it will take that text. If there is no text there, and only text\n// after the first subheading, it will take that text. It won't look any deeper\n// than that (in case the user intentionally wants to leave the section blank\n// for some reason). Skips lines that start with an exclamation point.\nvar getExcerptFromReadme = function (text) {\n  // Don't waste time parsing if the document is empty.\n  if (! text) {\n    return \"\";\n  }\n\n  // Split into lines with Commonmark.\n  var commonmark = require('commonmark');\n  var reader = new commonmark.DocParser();\n  var parsed = reader.parse(text);\n\n  // Commonmark will parse the Markdown into an array of nodes. These are the\n  // nodes that represent the text between the first and second heading.\n  var relevantNodes = [];\n\n  // Go through the document until we get the nodes that we are looking for,\n  // then stop.\n  _.any(parsed.children, function (child) {\n    var isHeader = (child.t === \"Header\");\n    // Don't excerpt anything before the first header.\n    if (! isHeader) {\n      // If we are currently in the middle of excerpting, continue doing that\n      // until we hit hit a header (and this is not a header). Otherwise, if\n      // this is text, we should begin to excerpt it.\n      relevantNodes.push(child);\n    } else if (! _.isEmpty(relevantNodes) && isHeader) {\n      // We have been excerpting, and came across a header. That means\n      // that we are done.\n      return true;\n    }\n    return false;\n  });\n\n  // If we have not found anything, we are done.\n  if (_.isEmpty(relevantNodes)) {\n    return \"\";\n  }\n\n  // For now, we will do the simple thing of just taking the raw markdown from\n  // the start of the excerpt to the end.\n  var textLines = text.split(\"\\n\");\n  var start = relevantNodes[0].start_line - 1;\n  var stop = _.last(relevantNodes).end_line;\n  // XXX: There is a bug in commonmark that happens when processing the last\n  // node in the document. Here is the github issue:\n  // https://github.com/jgm/CommonMark/issues/276\n  // Remove this workaround when the issue is fixed.\n  if (stop === _.last(parsed.children).end_line) {\n    stop++;\n  }\n  var excerpt = textLines.slice(start, stop).join(\"\\n\");\n\n  // Strip the preceeding and trailing new lines.\n  return excerpt.replace(/^\\n+|\\n+$/g, \"\");\n};\n\nclass SymlinkLoopChecker {\n  constructor(sourceRoot) {\n    this.sourceRoot = sourceRoot;\n    this._seenPaths = {};\n    this._realpathCache = {};\n  }\n\n  check(relDir, quietly = true) {\n    const absPath = files.pathJoin(this.sourceRoot, relDir);\n\n    try {\n      var realPath = files.realpath(absPath, this._realpathCache);\n    } catch (e) {\n      if (!e || e.code !== 'ELOOP') {\n        throw e;\n      }\n      // else leave realPath undefined\n    }\n\n    if (! realPath || _.has(this._seenPaths, realPath)) {\n      if (! quietly) {\n        buildmessage.error(\"Symlink cycle detected at \" + relDir);\n      }\n\n      return true;\n    }\n\n    this._seenPaths[realPath] = true;\n\n    return false;\n  }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n// PackageSource\n///////////////////////////////////////////////////////////////////////////////\n\nvar PackageSource = function () {\n  var self = this;\n\n  // The name of the package, or null for an app pseudo-package or\n  // collection. The package's exports will reside in Package.<name>.\n  // When it is null it is linked like an application instead of like\n  // a package.\n  self.name = null;\n\n  // The path relative to which all source file paths are interpreted\n  // in this package. Also used to compute the location of the\n  // package's .npm directory (npm shrinkwrap state).\n  self.sourceRoot = null;\n\n  // Path that will be prepended to the URLs of all resources emitted\n  // by this package (assuming they don't end up getting\n  // concatenated). For non-web targets, the only effect this will\n  // have is to change the actual on-disk paths of the files in the\n  // bundle, for those that care to open up the bundle and look (but\n  // it's still nice to get it right).\n  self.serveRoot = null;\n\n  // Package metadata. Keys are 'summary', 'git' and 'documentation'. Currently\n  // all of these are optional.\n  self.metadata = {};\n  self.docsExplicitlyProvided = false;\n\n  // Package version as a meteor-version string. Optional; not all packages\n  // (for example, the app) have versions.\n  // XXX when we have names, maybe we want to say that all packages\n  // with names have versions? certainly the reverse is true\n  self.version = null;\n  self.versionExplicitlyProvided = false;\n\n  // Available architectures of this package. Array of SourceArch.\n  self.architectures = [];\n\n  // The information necessary to build the plugins in this\n  // package. Map from plugin name to object with keys 'name', 'use',\n  // 'sources', and 'npmDependencies'.\n  self.pluginInfo = {};\n\n  // Analogous to watchSet in SourceArch but for plugins. At this\n  // stage will typically contain just 'package.js'.\n  self.pluginWatchSet = new watch.WatchSet;\n\n  // npm packages used by this package (on os.* architectures only).\n  // Map from npm package name to the required version of the package\n  // as a string.\n  self.npmDependencies = {};\n\n  // Files to be stripped from the installed NPM dependency tree. See the\n  // Npm.strip comment below for further usage information.\n  self.npmDiscards = null;\n\n  // Absolute path to a directory on disk that serves as a cache for\n  // the npm dependencies, so we don't have to fetch them on every\n  // build. Required not just if we have npmDependencies, but if we\n  // ever could have had them in the past.\n  self.npmCacheDirectory = null;\n\n  // cordova plugins used by this package (on os.* architectures only).\n  // Map from cordova plugin name to the required version of the package\n  // as a string.\n  self.cordovaDependencies = {};\n\n  // If this package has a corresponding test package (for example,\n  // underscore-test), defined in the same package.js file, store its value\n  // here.\n  self.testName = null;\n\n  // Test packages are dealt with differently in the linker (and not published\n  // to the catalog), so we need to keep track of them.\n  self.isTest = false;\n\n  // Some packages belong to a test framework and should never be bundled into\n  // production. A package with this flag should not be picked up by the bundler\n  // for production builds.\n  self.debugOnly = false;\n\n  // A package marked prodOnly is ONLY picked up by the bundler for production\n  // builds.\n  self.prodOnly = false;\n\n  // A package marked testOnly is ONLY picked up by the bundler as\n  // part of the `meteor test` command.\n  self.testOnly = false;\n\n  // If this is set, we will take the currently running git checkout and bundle\n  // the meteor tool from it inside this package as a tool. We will include\n  // built copies of all known isopackets.\n  self.includeTool = false;\n\n  // Is this a core package? Core packages don't record version files, because\n  // core packages are only ever run from checkout. For the preview release,\n  // core packages do not need to specify their versions at publication (since\n  // there isn't likely to be any exciting version skew yet), but we will\n  // specify the correct restrictions at 0.90.\n  // XXX: 0.90 package versions.\n  self.isCore = false;\n};\n\n\n_.extend(PackageSource.prototype, {\n  // Make a dummy (empty) packageSource that contains nothing of interest.\n  // XXX: Do we need this\n  initEmpty: function (name) {\n    var self = this;\n    self.name = name;\n  },\n\n  // Programmatically initialize a PackageSource from scratch.\n  //\n  // Unlike user-facing methods of creating a package\n  // (initFromPackageDir, initFromAppDir) this does not implicitly add\n  // a dependency on the 'meteor' package. If you want such a\n  // dependency then you must add it yourself.\n  //\n  // If called inside a buildmessage job, it will keep going if things\n  // go wrong. Be sure to call jobHasMessages to see if it actually\n  // succeeded.\n  //\n  // The architecture is hardcoded to be \"os\".\n  //\n  // Note that this does not set a version on the package!\n  //\n  // Options:\n  // - sourceRoot (required if sources present)\n  // - serveRoot (required if sources present)\n  // - use\n  // - sources (array of paths or relPath/fileOptions objects), note that this\n  // doesn't support assets at this time. If you want to pass assets here, you\n  // should add a new option to this function called `assets`.\n  // - npmDependencies\n  // - cordovaDependencies\n  // - npmDir\n  // - localNodeModulesDirs\n  initFromOptions: function (name, options) {\n    var self = this;\n    self.name = name;\n\n    if (options.sources && ! _.isEmpty(options.sources) &&\n        (! options.sourceRoot || ! options.serveRoot)) {\n      throw new Error(\"When source files are given, sourceRoot and \" +\n                      \"serveRoot must be specified\");\n    }\n\n    // sourceRoot is a relative file system path, one slash identifies a root\n    // relative to some starting location\n    self.sourceRoot = options.sourceRoot || files.pathSep;\n    // serveRoot is actually a part of a url path, root here is a forward slash\n    self.serveRoot = options.serveRoot || '/';\n\n    utils.ensureOnlyValidVersions(options.npmDependencies, {forCordova: false});\n    self.npmDependencies = options.npmDependencies;\n\n    // If options.npmDir is a string, make sure it contains no colons.\n    self.npmCacheDirectory = _.isString(options.npmDir)\n      ? convertColonsInPath(options.npmDir)\n      : options.npmDir;\n\n    utils.ensureOnlyValidVersions(options.cordovaDependencies, {forCordova: true});\n    self.cordovaDependencies = options.cordovaDependencies;\n\n    const sources = options.sources.map((source) => {\n      if (typeof source === \"string\") {\n        return {\n          relPath: source\n        };\n      }\n\n      return source;\n    });\n\n    const sourceArch = new SourceArch(self, {\n      kind: options.kind,\n      arch: \"os\",\n      sourceRoot: self.sourceRoot,\n      uses: _.map(options.use, splitConstraint),\n      getFiles() {\n        return {\n          sources: sources\n        }\n      }\n    });\n\n    if (options.localNodeModulesDirs) {\n      _.extend(sourceArch.localNodeModulesDirs,\n               options.localNodeModulesDirs);\n    }\n\n    self.architectures.push(sourceArch);\n\n    if (! self._checkCrossUnibuildVersionConstraints()) {\n      throw new Error(\"only one unibuild, so how can consistency check fail?\");\n    }\n  },\n\n  // Initialize a PackageSource from a package.js-style package directory. Uses\n  // the name field provided and the name/test fields in the package.js file to\n  // figre out if this is a test package (load from onTest) or a use package\n  // (load from onUse).\n  //\n  // name: name of the package.\n  // dir: location of directory on disk.\n  // options:\n  // - name: override the name of this package with a different name.\n  // - buildingIsopackets: true if this is being scanned in the process\n  //   of building isopackets\n  initFromPackageDir: Profile(\"PackageSource#initFromPackageDir\", function (dir, options) {\n    var self = this;\n    buildmessage.assertInCapture();\n    var isPortable = true;\n    options = options || {};\n    var initFromPackageDirOptions = options;\n\n    // If we know what package we are initializing, we pass in a\n    // name. Otherwise, we are intializing the base package specified by 'name:'\n    // field in Package.Describe. In that case, it is clearly not a test\n    // package. (Though we could be initializing a specific package without it\n    // being a test, for a variety of reasons).\n    if (options.name) {\n      self.isTest = isTestName(options.name);\n      self.name = options.name;\n    }\n\n    // Give the package a default version. We do not set\n    // versionExplicitlyProvided unless the package configuration file actually\n    // sets a version.\n    self.version = \"0.0.0\";\n\n    // To make the transition to using README.md files in Isobuild easier, we\n    // initialize the documentation directory to README.md by default.\n    self.metadata.documentation = \"README.md\";\n\n    self.sourceRoot = dir;\n\n    // If we are running from checkout we may be looking at a core package. If\n    // we are, let's remember this for things like not recording version files.\n    if (files.inCheckout()) {\n      var packDir = files.pathJoin(files.getCurrentToolsDir(), 'packages');\n      if (files.pathDirname(self.sourceRoot) === packDir) {\n        self.isCore = true;\n      }\n    }\n    if (! files.exists(self.sourceRoot)) {\n      throw new Error(\"putative package directory \" + dir + \" doesn't exist?\");\n    }\n\n    const packageFileHashes = Object.create(null);\n    const packageJsPath = files.pathJoin(self.sourceRoot, 'package.js');\n    const packageJsCode = optimisticReadFile(packageJsPath);\n    packageFileHashes[packageJsPath] =\n      optimisticHashOrNull(packageJsPath);\n\n    const pkgJsonPath = files.pathJoin(self.sourceRoot, 'package.json');\n    const pkgJsonStat = optimisticStatOrNull(pkgJsonPath);\n    if (pkgJsonStat &&\n        pkgJsonStat.isFile()) {\n      packageFileHashes[pkgJsonPath] =\n        optimisticHashOrNull(pkgJsonPath);\n    }\n\n    function watchPackageFiles(watchSet) {\n      _.each(packageFileHashes, (hash, path) => {\n        watchSet.addFile(path, hash);\n      });\n    }\n\n    // Any package that depends on us needs to be rebuilt if our package.js file\n    // changes, because a change to package.js might add or remove a plugin,\n    // which could change a file from being handled by plugin vs treated as\n    // an asset.\n    watchPackageFiles(self.pluginWatchSet);\n\n    /**\n     * @global\n     * @name  Package\n     * @summary The Package object in package.js\n     * @namespace\n     * @locus package.js\n     */\n    const Package = new PackageNamespace(this);\n\n    /**\n     * @namespace Npm\n     * @global\n     * @summary The Npm object in package.js and package source files.\n     */\n    const Npm = new PackageNpm();\n\n    /**\n     * @namespace Cordova\n     * @global\n     * @summary The Cordova object in package.js.\n     */\n    const Cordova = new PackageCordova();\n\n    try {\n      files.runJavaScript(packageJsCode.toString('utf8'), {\n        filename: 'package.js',\n        symbols: { Package, Npm, Cordova }\n      });\n    } catch (e) {\n      buildmessage.exception(e);\n\n      // Could be a syntax error or an exception. Recover by\n      // continuing as if package.js is empty. (Pressing on with\n      // whatever handlers were registered before the exception turns\n      // out to feel pretty disconcerting -- definitely violates the\n      // principle of least surprise.) Leave the metadata if we have\n      // it, though.\n      Package._fileAndDepLoader = null;\n      self.pluginInfo = {};\n      Npm._dependencies = null;\n      Cordova._dependencies = null;\n    }\n\n    // In the past, we did not require a Package.Describe.name field. So, it is\n    // possible that we are initializing a package that doesn't use it and\n    // expects us to be implicit about it.\n    if (!self.name) {\n      // For backwards-compatibility, we will take the package name from the\n      // directory of the package. That was what we used to do: in fact, we used\n      // to only do that.\n      self.name = files.pathBasename(dir);\n    }\n\n    // Check to see if our name is valid.\n\n    try {\n      utils.validatePackageName(self.name);\n    } catch (e) {\n      if (!e.versionParserError) {\n        throw e;\n      }\n      buildmessage.error(e.message);\n      // recover by ignoring\n    }\n\n    // We want the \"debug mode\" to be a property of the *bundle* operation\n    // (turning a set of packages, including the app, into a star), not the\n    // *compile* operation (turning a package source into an isopack). This is\n    // so we don't have to publish two versions of each package. But we have no\n    // way to mark a file in an isopack as being the result of running a plugin\n    // from a debugOnly dependency, and so there is no way to tell which files\n    // to exclude in production mode from a published package. Eventually, we'll\n    // add such a flag to the isopack format, but until then we'll sidestep the\n    // issue by disallowing build plugins in debugOnly packages.\n    if ((self.debugOnly || self.prodOnly || self.testOnly) && !_.isEmpty(self.pluginInfo)) {\n      buildmessage.error(\n        \"can't register build plugins in debugOnly, prodOnly or testOnly packages\");\n      // recover by ignoring\n    }\n\n    // For this old-style, onUse/onTest/where-based package, figure\n    // out its dependencies by calling its on_xxx functions and seeing\n    // what it does.\n    //\n    // We have a simple strategy. Call its on_xxx handler with no\n    // 'where', which is what happens when the package is added\n    // directly to an app, and see what files it adds to the client\n    // and the server. When a package is used, include it in both the client\n    // and the server by default. This simple strategy doesn't capture even\n    // 10% of the complexity possible with onUse, onTest, and where, but\n    // probably is sufficient for virtually all packages that actually\n    // exist in the field, if not every single one. #OldStylePackageSupport\n\n    var api = new PackageAPI({\n      buildingIsopackets: !! initFromPackageDirOptions.buildingIsopackets\n    });\n\n    if (Package._fileAndDepLoader) {\n      try {\n        buildmessage.markBoundary(Package._fileAndDepLoader)(api);\n      } catch (e) {\n        console.log(e.stack); // XXX should we keep this here -- or do we want broken\n                              // packages to fail silently?\n        buildmessage.exception(e);\n\n        // Recover by ignoring all of the source files in the\n        // packages and any remaining handlers. It violates the\n        // principle of least surprise to half-run a handler\n        // and then continue.\n        api.files = {};\n        _.each(compiler.ALL_ARCHES, function (arch) {\n          api.files[arch] = {\n            sources: [],\n            assets: []\n          };\n        });\n\n        Package._fileAndDepLoader = null;\n        self.pluginInfo = {};\n        Npm._dependencies = null;\n        Cordova._dependencies = null;\n      }\n    }\n\n    // By the way, you can't depend on yourself.\n    var doNotDepOnSelf = function (dep) {\n      if (dep.package === self.name) {\n        buildmessage.error(\"Circular dependency found: \"\n                           + self.name +\n                           \" depends on itself.\\n\");\n      }\n    };\n    _.each(compiler.ALL_ARCHES, function (label) {\n      _.each(api.uses[label], doNotDepOnSelf);\n      _.each(api.implies[label], doNotDepOnSelf);\n    });\n\n    // Cause packages that use `prodOnly` to automatically depend on the\n    // `isobuild:prod-only` feature package, which will cause an error\n    // when a package using `prodOnly` is run by a version of the tool\n    // that doesn't support the feature.  The choice of 'os' architecture\n    // is arbitrary, as the version solver combines the dependencies of all\n    // arches.\n    if (self.prodOnly) {\n      api.uses['os'].push({\n        package: 'isobuild:prod-only', constraint: '1.0.0'\n      });\n    }\n\n    // If we have specified some release, then we should go through the\n    // dependencies and fill in the unspecified constraints with the versions in\n    // the releases (if possible).\n    if (!_.isEmpty(api.releaseRecords)) {\n\n      // Given a dependency object with keys package (the name of the package)\n      // and constraint (the version constraint), if the constraint is null,\n      // look in the packages field in the release record and fill in from\n      // there.\n      var setFromRel = function (dep) {\n        if (dep.constraint) {\n          return dep;\n        }\n        var newConstraint = [];\n        _.each(api.releaseRecords, function (releaseRecord) {\n          var packages = releaseRecord.packages;\n          if(_.has(packages, dep.package)) {\n            newConstraint.push(packages[dep.package]);\n          }\n        });\n        if (_.isEmpty(newConstraint)) {\n          return dep;\n        }\n        dep.constraint = _.reduce(newConstraint,\n          function(x, y) {\n            return x + \" || \" + y;\n          });\n        return dep;\n      };\n\n      // For all api.implies and api.uses, fill in the unspecified dependencies from the\n      // release.\n      _.each(compiler.ALL_ARCHES, function (label) {\n        api.uses[label] = _.map(api.uses[label], setFromRel);\n        api.implies[label] = _.map(api.implies[label], setFromRel);\n      });\n     };\n\n    // Make sure that if a dependency was specified in multiple\n    // unibuilds, the constraint is exactly the same.\n    if (! self._checkCrossUnibuildVersionConstraints()) {\n      // A build error was written. Recover by ignoring the\n      // fact that we have differing constraints.\n    }\n\n    // Save information about npm dependencies. To keep metadata\n    // loading inexpensive, we won't actually fetch them until build\n    // time.\n\n    // We used to put the cache directly in .npm, but in linker-land,\n    // the package's own NPM dependencies go in .npm/package and build\n    // plugin X's goes in .npm/plugin/X. Notably, the former is NOT an\n    // ancestor of the latter, so that a build plugin does NOT see the\n    // package's node_modules.  XXX maybe there should be separate NPM\n    // dirs for use vs test?\n    self.npmCacheDirectory =\n      files.pathResolve(files.pathJoin(self.sourceRoot, '.npm', 'package'));\n    self.npmDependencies = Npm._dependencies;\n    self.npmDiscards = Npm._discards;\n\n    self.cordovaDependencies = Cordova._dependencies;\n\n    // Create source architectures, one for the server and one for each web\n    // arch.\n    _.each(compiler.ALL_ARCHES, function (arch) {\n      // Everything depends on the package 'meteor', which sets up\n      // the basic environment) (except 'meteor' itself).\n      if (self.name !== \"meteor\" && !process.env.NO_METEOR_PACKAGE) {\n        // Don't add the dependency if one already exists. This allows the\n        // package to create an unordered dependency and override the one that\n        // we'd add here. This is necessary to resolve the circular dependency\n        // between meteor and underscore (underscore has an unordered\n        // dependency on meteor dating from when the .js extension handler was\n        // in the \"meteor\" package).\n        var alreadyDependsOnMeteor =\n              !! _.find(api.uses[arch], function (u) {\n                return u.package === \"meteor\";\n              });\n        if (! alreadyDependsOnMeteor) {\n          api.uses[arch].unshift({ package: \"meteor\" });\n        }\n      }\n\n      // Each unibuild has its own separate WatchSet. This is so that, eg, a test\n      // unibuild's dependencies doesn't end up getting merged into the\n      // pluginWatchSet of a package that uses it: only the use unibuild's\n      // dependencies need to go there!\n      var watchSet = new watch.WatchSet();\n      watchPackageFiles(watchSet);\n\n      self.architectures.push(new SourceArch(self, {\n        kind: \"main\",\n        arch: arch,\n        sourceRoot: self.sourceRoot,\n        uses: api.uses[arch],\n        implies: api.implies[arch],\n        getFiles(sourceProcessorSet, watchSet) {\n          const result = api.files[arch];\n          const relPathToSourceObj = {};\n          const sources = result.sources;\n\n          // Files explicitly passed to api.addFiles remain at the\n          // beginning of api.files[arch].sources in their given order.\n          sources.forEach(sourceObj => {\n            relPathToSourceObj[sourceObj.relPath] = sourceObj;\n          });\n\n          self._findSources({\n            sourceProcessorSet,\n            watchSet,\n            sourceArch: this,\n            isApp: false\n          }).forEach(relPath => {\n            if (! _.has(relPathToSourceObj, relPath)) {\n              const fileOptions = self._inferFileOptions(relPath, {\n                arch,\n                isApp: false,\n              });\n\n              // Since this file was not explicitly added with\n              // api.addFiles, it should not be evaluated eagerly.\n              fileOptions.lazy = true;\n\n              sources.push(relPathToSourceObj[relPath] = {\n                relPath,\n                fileOptions,\n              });\n            }\n          });\n\n          return result;\n        },\n        declaredExports: api.exports[arch],\n        watchSet: watchSet\n      }));\n    });\n\n    // Serve root of the package.\n    self.serveRoot = files.pathJoin('/packages/', self.name);\n\n    // Name of the test.\n    if (Package._hasTests) {\n      self.testName = genTestName(self.name);\n    }\n  }),\n\n  _readAndWatchDirectory(relDir, watchSet, {include, exclude, names}) {\n    return watch.readAndWatchDirectory(watchSet, {\n      absPath: files.pathJoin(this.sourceRoot, relDir),\n      include, exclude, names\n    }).map(name => files.pathJoin(relDir, name));\n  },\n\n  // Initialize a package from an application directory (has .meteor/packages).\n  initFromAppDir: Profile(\"initFromAppDir\", function (projectContext, ignoreFiles) {\n    var self = this;\n    var appDir = projectContext.projectDir;\n    self.name = null;\n    self.sourceRoot = appDir;\n    self.serveRoot = '/';\n\n    // Determine used packages. Note that these are the same for all arches,\n    // because there's no way to specify otherwise in .meteor/packages.\n    var uses = [];\n    projectContext.projectConstraintsFile.eachConstraint(function (constraint) {\n      uses.push({ package: constraint.package,\n                  constraint: constraint.constraintString });\n    });\n\n    var projectWatchSet = projectContext.getProjectWatchSet();\n\n    _.each(compiler.ALL_ARCHES, function (arch) {\n      // We don't need to build a Cordova SourceArch if there are no Cordova\n      // platforms.\n      if (arch === 'web.cordova' &&\n          _.isEmpty(projectContext.platformList.getCordovaPlatforms())) {\n        return;\n      }\n\n      // XXX what about /web.browser/* etc, these directories could also\n      // be for specific client targets.\n\n      // Create unibuild\n      var sourceArch = new SourceArch(self, {\n        kind: 'app',\n        arch: arch,\n        sourceRoot: self.sourceRoot,\n        uses: uses,\n        getFiles(sourceProcessorSet, watchSet) {\n          sourceProcessorSet.watchSet = watchSet;\n\n          const findOptions = {\n            sourceProcessorSet,\n            watchSet,\n            sourceArch: this,\n            ignoreFiles,\n            isApp: true,\n            loopChecker: new SymlinkLoopChecker(self.sourceRoot)\n          };\n\n          return {\n            sources: self._findSources(findOptions).sort(\n              loadOrderSort(sourceProcessorSet, arch)\n            ).map(relPath => {\n              return {\n                relPath,\n                fileOptions: self._inferFileOptions(relPath, {\n                  arch,\n                  isApp: true,\n                }),\n              };\n            }),\n\n            assets: self._findAssets(findOptions),\n          };\n        }\n      });\n\n      const origAppDir = projectContext.getOriginalAppDirForTestPackages();\n\n      const origNodeModulesDir = origAppDir &&\n        files.pathJoin(origAppDir, \"node_modules\");\n\n      const origNodeModulesStat = origNodeModulesDir &&\n        files.statOrNull(origNodeModulesDir);\n\n      if (origNodeModulesStat &&\n          origNodeModulesStat.isDirectory()) {\n        sourceArch.localNodeModulesDirs[\"node_modules\"] = {\n          // Override these properties when calling\n          // addNodeModulesDirectory in compileUnibuild.\n          sourceRoot: origAppDir,\n          sourcePath: origNodeModulesDir,\n          local: false,\n        };\n      }\n\n      self.architectures.push(sourceArch);\n\n      // sourceArch's WatchSet should include all the project metadata files\n      // read by the ProjectContext.\n      sourceArch.watchSet.merge(projectWatchSet);\n    });\n\n    if (! self._checkCrossUnibuildVersionConstraints()) {\n      // should never happen since we created the unibuilds from\n      // .meteor/packages, which doesn't have a way to express\n      // different constraints for different unibuilds\n      throw new Error(\"conflicting constraints in a package?\");\n    }\n  }),\n\n  _inferFileOptions(relPath, {arch, isApp}) {\n    const fileOptions = {};\n    const isTest = global.testCommandMetadata\n      && global.testCommandMetadata.isTest;\n    const isAppTest = global.testCommandMetadata\n      && global.testCommandMetadata.isAppTest;\n    const isTestFile = (isTest || isAppTest) && isTestFilePath(relPath);\n\n    // If running in test mode (`meteor test`), all files other than\n    // test files should be loaded lazily.\n    if (isTest && !isTestFile) {\n      fileOptions.lazy = true;\n    }\n\n    const dirs = files.pathDirname(relPath).split(files.pathSep);\n\n    for (var i = 0; i < dirs.length; ++i) {\n      let dir = dirs[i];\n\n      if (dir === \"node_modules\") {\n        fileOptions.lazy = true;\n        fileOptions.transpile = false;\n\n        // Return immediately so that we don't apply special meanings to\n        // client or server directories inside node_modules directories.\n        return fileOptions;\n      }\n\n      // Files in `imports/` should be lazily loaded *apart* from tests\n      if (isApp && dir === \"imports\" && !isTestFile) {\n        fileOptions.lazy = true;\n      }\n\n      // If the file is restricted to the opposite architecture, make sure\n      // it is not evaluated eagerly.\n      if (archinfo.matches(arch, \"os\")) {\n        if (dir === \"client\") {\n          fileOptions.lazy = true;\n        }\n      } else if (dir === \"server\") {\n        fileOptions.lazy = true;\n      }\n\n      // Special case: in app code on the client, JavaScript files in a\n      // `client/compatibility` directory don't get wrapped in a closure.\n      if (i > 0 &&\n          dirs[i - 1] === \"client\" &&\n          dir === \"compatibility\" &&\n          isApp && // Skip this check for packages.\n          archinfo.matches(arch, \"web\") &&\n          relPath.endsWith(\".js\")) {\n        fileOptions.bare = true;\n      }\n    }\n\n    return fileOptions;\n  },\n\n  // This cache survives for the duration of the process, and stores the\n  // complete list of source files for directories within node_modules.\n  _findSourcesCache: Object.create(null),\n\n  _findSources({\n    sourceProcessorSet,\n    watchSet,\n    isApp,\n    sourceArch,\n    loopChecker = new SymlinkLoopChecker(this.sourceRoot),\n    ignoreFiles = []\n  }) {\n    const self = this;\n    const arch = sourceArch.arch;\n    const sourceReadOptions =\n      sourceProcessorSet.appReadDirectoryOptions(arch);\n\n    // Ignore files starting with dot (unless they are explicitly in\n    // 'names').\n    sourceReadOptions.exclude.push(/^\\./);\n    // Ignore the usual ignorable files.\n    sourceReadOptions.exclude.push(...ignoreFiles);\n\n    // Unless we're running tests, ignore all test filenames and if we are, ignore the\n    // type of file we *aren't* running\n    if (!global.testCommandMetadata || global.testCommandMetadata.isTest) {\n      Array.prototype.push.apply(sourceReadOptions.exclude, APP_TEST_FILENAME_REGEXPS);\n    }\n    if (!global.testCommandMetadata || global.testCommandMetadata.isAppTest) {\n      Array.prototype.push.apply(sourceReadOptions.exclude, TEST_FILENAME_REGEXPS);\n    }\n\n    // Read top-level source files, excluding control files that were not\n    // explicitly included.\n    const controlFiles = ['mobile-config.js'];\n\n    if (! isApp) {\n      controlFiles.push('package.js');\n    }\n\n    const anyLevelExcludes = [\n      /^tests\\/$/,\n      archinfo.matches(arch, \"os\")\n        ? /^client\\/$/\n        : /^server\\/$/,\n      ...sourceReadOptions.exclude,\n    ];\n\n    const topLevelExcludes = isApp ? [\n      ...anyLevelExcludes,\n      /^packages\\/$/,\n      /^programs\\/$/,\n      /^public\\/$/, /^private\\/$/,\n      /^cordova-build-override\\/$/,\n      /^acceptance-tests\\/$/,\n    ] : anyLevelExcludes;\n\n    const nodeModulesReadOptions = {\n      ...sourceReadOptions,\n      // When we're in a node_modules directory, we can avoid collecting\n      // .js and .json files, because (unlike .less or .coffee files) they\n      // are allowed to be imported later by the ImportScanner, as they do\n      // not require custom processing by compiler plugins.\n      exclude: sourceReadOptions.exclude.concat(/\\.js(on)?$/i),\n    };\n\n    const baseCacheKey = JSON.stringify({\n      isApp,\n      arch,\n      sourceRoot: self.sourceRoot,\n      excludes: anyLevelExcludes,\n    }, (key, value) => {\n      if (_.isRegExp(value)) {\n        return [value.source, value.flags];\n      }\n      return value;\n    });\n\n    function makeCacheKey(dir) {\n      return baseCacheKey + \"\\0\" + dir;\n    }\n\n    function find(dir, depth, inNodeModules) {\n      // Remove trailing slash.\n      dir = dir.replace(/\\/$/, \"\");\n\n      // If we're in a node_modules directory, cache the results of the\n      // find function for the duration of the process.\n      const cacheKey = inNodeModules && makeCacheKey(dir);\n      if (cacheKey &&\n          cacheKey in self._findSourcesCache) {\n        return self._findSourcesCache[cacheKey];\n      }\n\n      if (loopChecker.check(dir)) {\n        // Pretend we found no files.\n        return [];\n      }\n\n      const readOptions = inNodeModules\n        ? nodeModulesReadOptions\n        : sourceReadOptions;\n\n      const sources = _.difference(\n        self._readAndWatchDirectory(dir, watchSet, readOptions),\n        depth > 0 ? [] : controlFiles\n      );\n\n      const subdirectories = self._readAndWatchDirectory(dir, watchSet, {\n        include: [/\\/$/],\n        exclude: depth > 0\n          ? anyLevelExcludes\n          : topLevelExcludes\n      });\n\n      let nodeModulesDir;\n\n      subdirectories.forEach(subdir => {\n        if (/(^|\\/)node_modules\\/$/.test(subdir)) {\n          if (! inNodeModules) {\n            sourceArch.localNodeModulesDirs[subdir] = true;\n          }\n\n          // Defer handling node_modules until after we handle all other\n          // subdirectories, so that we know whether we need to descend\n          // further. If sources is still empty after we handle everything\n          // else in dir, then nothing in this node_modules subdir can be\n          // imported by anthing outside of it, so we can ignore it.\n          nodeModulesDir = subdir;\n\n        } else {\n          sources.push(...find(subdir, depth + 1, inNodeModules));\n        }\n      });\n\n      if (isApp &&\n          nodeModulesDir &&\n          (! inNodeModules || sources.length > 0)) {\n        // If we found a node_modules subdirectory above, and either we\n        // are not already inside another node_modules directory or we\n        // found source files elsewhere in this directory or its other\n        // subdirectories, and we're building an app (as opposed to a\n        // Meteor package), continue searching this node_modules\n        // directory, so that any non-.js(on) files it contains can be\n        // imported by the app (#6037).\n        sources.push(...find(nodeModulesDir, depth + 1, true));\n      }\n\n      if (cacheKey) {\n        self._findSourcesCache[cacheKey] = sources;\n      }\n\n      return sources;\n    }\n\n    return files.withCache(() => find(\"\", 0, false));\n  },\n\n  _findAssets({\n    sourceProcessorSet,\n    watchSet,\n    isApp,\n    sourceArch,\n    loopChecker = new SymlinkLoopChecker(this.sourceRoot),\n    ignoreFiles = [],\n  }) {\n    // Now look for assets for this unibuild.\n    const arch = sourceArch.arch;\n    const assetDir = archinfo.matches(arch, \"web\") ? \"public/\" : \"private/\";\n    var assetDirs = this._readAndWatchDirectory('', watchSet, {\n      names: [assetDir]\n    });\n\n    const assets = [];\n\n    if (!_.isEmpty(assetDirs)) {\n      if (!_.isEqual(assetDirs, [assetDir])) {\n        throw new Error(\"Surprising assetDirs: \" + JSON.stringify(assetDirs));\n      }\n\n      while (!_.isEmpty(assetDirs)) {\n        dir = assetDirs.shift();\n        // remove trailing slash\n        dir = dir.substr(0, dir.length - 1);\n\n        if (loopChecker.check(dir)) {\n          // pretend we found no files\n          return [];\n        }\n\n        // Find asset files in this directory.\n        var assetsAndSubdirs = this._readAndWatchDirectory(dir, watchSet, {\n          include: [/.?/],\n          // we DO look under dot directories here\n          exclude: ignoreFiles\n        });\n\n        _.each(assetsAndSubdirs, function (item) {\n          if (item[item.length - 1] === '/') {\n            // Recurse on this directory.\n            assetDirs.push(item);\n          } else {\n            // This file is an asset.\n            assets.push({\n              relPath: item\n            });\n          }\n        });\n      }\n    }\n\n    return assets;\n  },\n\n  // True if the package defines any plugins.\n  containsPlugins: function () {\n    var self = this;\n    return ! _.isEmpty(self.pluginInfo);\n  },\n\n  // Return dependency metadata for all unibuilds, in the format needed\n  // by the package catalog.\n  //\n  // This *DOES* include isobuild:* pseudo-packages!\n  //\n  // Options:\n  // - logError: if true, if something goes wrong, log a buildmessage\n  //   and return null rather than throwing an exception.\n  // - skipWeak: omit weak dependencies\n  // - skipUnordered: omit unordered dependencies\n  getDependencyMetadata: function (options) {\n    var self = this;\n    options = options || {};\n    var ret = self._computeDependencyMetadata(options);\n    if (! ret) {\n      if (options.logError) {\n        return null;\n      } else {\n        throw new Error(\"inconsistent dependency constraint across unibuilds?\");\n      }\n    }\n    return ret;\n  },\n\n  // Returns a list of package names which should be loaded before building this\n  // package. This is all the packages that we directly depend on in a unibuild\n  // or from a plugin.\n  //\n  // (It's possible that we could do something slightly fancier where we only\n  // need to load those dependencies (including implied dependencies) which we\n  // know contain plugins first, plus the transitive closure of all the packages\n  // we depend on which contain a plugin. This seems good enough, though.)\n  //\n  // Note that this method filters out isobuild:* pseudo-packages, so it is NOT\n  // to be used to create input to Version Solver (see\n  // _computeDependencyMetadata for that).\n  //\n  // Note also that \"load\" here specifically means \"load into the IsopackCache\n  // at build time\", not \"load into a running Meteor app at run\n  // time\". Specifically, weak constraints do create a run-time load order\n  // dependency (if the package is in the app at all) but they do not create a\n  // build-time IsopackCache load order dependency (because weak dependencies do\n  // not provide plugins).\n  getPackagesToLoadFirst: function (packageMap) {\n    var self = this;\n    var packages = {};\n    var processUse = function (use) {\n      // We don't have to build weak or unordered deps first (eg they can't\n      // contribute to a plugin).\n      if (use.weak || use.unordered) {\n        return;\n      }\n      // Only include real packages, not isobuild:* pseudo-packages.\n      if (compiler.isIsobuildFeaturePackage(use.package)) {\n        return;\n      }\n\n      var packageInfo = packageMap.getInfo(use.package);\n      if (! packageInfo) {\n        throw Error(\"Depending on unknown package \" + use.package);\n      }\n      packages[use.package] = true;\n    };\n\n    _.each(self.architectures, function (arch) {\n      // We need to iterate over both uses and implies, since implied packages\n      // also constitute dependencies. We don't have to include the dependencies\n      // of implied packages directly here, since their own\n      // getPackagesToLoadFirst will include those.\n      _.each(arch.uses, processUse);\n      _.each(arch.implies, processUse);\n    });\n\n    _.each(self.pluginInfo, function (info) {\n      // info.use is currently just an array of strings, and there's\n      // no way to specify weak/unordered. Much like an app.\n      _.each(info.use, function (spec) {\n        var parsedSpec = splitConstraint(spec);\n        if (! compiler.isIsobuildFeaturePackage(parsedSpec.package)) {\n          packages[parsedSpec.package] = true;\n        }\n      });\n    });\n    return _.keys(packages);\n  },\n\n  // Returns an array of objects, representing this package's public\n  // exports. Each object has the following keys:\n  //  - name: export name (ex: \"Accounts\")\n  //  - arch: an array of strings representing architectures for which this\n  //    export is declared.\n  //\n  // This ignores testOnly exports.\n  getExports: function () {\n    var self = this;\n    var ret = {};\n    // Go over all of the architectures, and aggregate the exports together.\n    _.each(self.architectures, function (arch) {\n      _.each(arch.declaredExports, function (exp) {\n        // Skip testOnly exports -- the flag is intended for use in testing\n        // only, so it is not of any interest outside this package.\n        if (exp.testOnly) {\n          return;\n        }\n        // Add the export to the export map.\n        if (! _.has(ret, exp.name)) {\n          ret[exp.name] = [arch.arch];\n        } else {\n          ret[exp.name].push(arch.arch);\n        }\n     });\n    });\n    return _.map(ret, function (arches, name) {\n      return { name: name, architectures: arches };\n    });\n   },\n\n  // Processes the documentation provided in Package.describe. Returns an object\n  // with the following keys:\n  //   - path: full filepath to the Readme file\n  //   - excerpt: the subsection between the first and second heading of the\n  //     Readme, to be used as a longform package description.\n  //   - hash: hash of the full text of this Readme, or \"\" if the Readme is\n  //     blank.\n  //\n  // Returns null if the documentation is marked as null, or throws a\n  // buildmessage error if the documentation could not be read.\n  //\n  // This function reads and performs string operations on a (potentially) long\n  // file. We do not call it unless we actually need this information.\n  processReadme: function () {\n    var self = this;\n    buildmessage.assertInJob();\n    if (! self.metadata.documentation) {\n      return null;\n    }\n\n    // To ensure atomicity, we want to copy the README to a temporary file.\n    var ret = {};\n    ret.path =\n      files.pathJoin(self.sourceRoot, self.metadata.documentation);\n    // Read in the text of the Readme.\n    try {\n      var fullReadme = files.readFile(ret.path);\n    } catch (err) {\n      var errorMessage = \"\";\n      if (err.code === \"ENOENT\") {\n        // This is the most likely and common case, especially when we are\n        // inferring the docs as a default value.\n        errorMessage = \"Documentation not found: \" + self.metadata.documentation;\n      } else {\n        // This is weird, and we don't usually protect the user from errors like\n        // this, but maybe we should.\n        errorMessage =\n          \"Documentation couldn't be read: \" + self.metadata.documentation + \" \";\n        errorMessage += \"(Error: \" + err.message + \")\";\n      }\n\n      // The user might not understand that we are automatically inferring\n      // README.md as the docs! If they want to avoid pushing anything, explain\n      // how to do that.\n      if (! self.docsExplicitlyProvided) {\n        errorMessage += \"\\n\" +\n          \"If you don't want to publish any documentation, \" +\n          \"please set 'documentation: null' in Package.describe\";\n      }\n      buildmessage.error(errorMessage);\n      // Recover by returning null\n      return null;\n    }\n\n    var text = fullReadme.toString();\n    return {\n      contents: text,\n      hash: utils.sha256(text),\n      excerpt: getExcerptFromReadme(text)\n    };\n  },\n\n  // If dependencies aren't consistent across unibuilds, return false and\n  // also log a buildmessage error if inside a buildmessage job. Else\n  // return true.\n  // XXX: Check that this is used when refactoring is done.\n  _checkCrossUnibuildVersionConstraints: function () {\n    var self = this;\n    return !! self._computeDependencyMetadata({ logError: true });\n  },\n\n  // Compute the return value for getDependencyMetadata, or return\n  // null if there is a dependency that doesn't have the same\n  // constraint across all unibuilds (and, if logError is true, log a\n  // buildmessage error).\n  //\n  // This *DOES* include isobuild:* pseudo-packages!\n  //\n  // For options, see getDependencyMetadata.\n  _computeDependencyMetadata: function (options) {\n    var self = this;\n    options = options || {};\n\n    var dependencies = {};\n    var allConstraints = {}; // for error reporting. package name to array\n    var failed = false;\n\n    _.each(self.architectures, function (arch) {\n      // We need to iterate over both uses and implies, since implied packages\n      // also constitute dependencies.\n      var processUse = function (implied, use) {\n        // We can't really have a weak implies (what does that even mean?) but\n        // we check for that elsewhere.\n        if ((use.weak && options.skipWeak) ||\n            (use.unordered && options.skipUnordered)) {\n          return;\n        }\n\n        if (!_.has(dependencies, use.package)) {\n          dependencies[use.package] = {\n            constraint: null,\n            references: []\n          };\n          allConstraints[use.package] = [];\n        }\n        var d = dependencies[use.package];\n\n        if (use.constraint) {\n          allConstraints[use.package].push(use.constraint);\n\n          if (d.constraint === null) {\n            d.constraint = use.constraint;\n          } else if (d.constraint !== use.constraint) {\n            failed = true;\n          }\n        }\n\n        var reference = {\n          arch: archinfo.withoutSpecificOs(arch.arch)\n        };\n        if (use.weak) {\n          reference.weak = true;\n        }\n        if (use.unordered) {\n          reference.unordered = true;\n        }\n        if (implied) {\n          reference.implied = true;\n        }\n        d.references.push(reference);\n      };\n      _.each(arch.uses, _.partial(processUse, false));\n      _.each(arch.implies, _.partial(processUse, true));\n    });\n\n    _.each(self.pluginInfo, function (info) {\n      _.each(info.use, function (spec) {\n        var parsedSpec = splitConstraint(spec);\n        if (!_.has(dependencies, parsedSpec.package)) {\n          dependencies[parsedSpec.package] = {\n            constraint: null,\n            references: []\n          };\n          allConstraints[parsedSpec.package] = [];\n        }\n        var d = dependencies[parsedSpec.package];\n\n        if (parsedSpec.constraint) {\n          allConstraints[parsedSpec.package].push(parsedSpec.constraint);\n          if (d.constraint === null) {\n            d.constraint = parsedSpec.constraint;\n          } else if (d.constraint !== parsedSpec.constraint) {\n            failed = true;\n          }\n        }\n        d.references.push({arch: 'plugin'});\n      });\n    });\n\n    if (failed && options.logError) {\n      _.each(allConstraints, function (constraints, name) {\n        constraints = _.uniq(constraints);\n        if (constraints.length > 1) {\n          buildmessage.error(\n            \"The version constraint for a dependency must be the same \" +\n              \"at every place it is mentioned in a package. \" +\n              \"'\" + name + \"' is constrained both as \"  +\n              constraints.join(' and ') + \". Change them to match.\");\n          // recover by returning false (the caller had better detect\n          // this and use its own recovery logic)\n        }\n      });\n    }\n\n    return failed ? null : dependencies;\n  },\n\n  displayName() {\n    return this.name === null ? 'the app' : this.name;\n  }\n});\n\nmodule.exports = PackageSource;\n"]}