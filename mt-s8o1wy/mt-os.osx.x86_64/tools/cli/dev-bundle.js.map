{"version":3,"sources":["/tools/cli/dev-bundle.js"],"names":["fs","require","path","links","rootDir","resolve","__dirname","defaultDevBundlePromise","Promise","join","getDevBundleDir","releaseFile","find","process","cwd","makeStatTest","localDir","dirname","statOrNull","mkdirSync","e","devBundleLink","devBundleStat","readLink","release","readFileSync","replace","test","getDevBundleForRelease","then","devBundleDir","makeLink","parts","split","length","track","version","slice","packageMetadataDir","meteorToolDir","meteorToolStat","dbPath","dbStat","sqlite3","db","Database","reject","get","error","data","tool","JSON","parse","content","getHostArch","console","stack","statMethod","stat","statSync","code","dir","predicate","joinArgs","Array","prototype","call","arguments","unshift","joined","apply","parentDir","method","file","platform","arch","module","exports"],"mappings":"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","file":"tools/cli/dev-bundle.js.map","sourcesContent":["// Note that this file is required before we install our Babel hooks in\n// ../tool-env/install-babel.js, so we can't use ES2015+ syntax here.\n\n// This file replicates some functionality from elsewhere in tools code,\n// but that's unavoidable if we don't want to install Babel and load all\n// the rest of the code every time we run `meteor npm` or `meteor node`.\n\nvar fs = require(\"fs\");\nvar path = require(\"path\");\nvar links = require(\"./dev-bundle-links.js\");\nvar rootDir = path.resolve(__dirname, \"..\", \"..\");\nvar defaultDevBundlePromise =\n  Promise.resolve(path.join(rootDir, \"dev_bundle\"));\n\nfunction getDevBundleDir() {\n  // Note that this code does not care if we are running meteor from a\n  // checkout, because it's always better to respect the .meteor/release\n  // file of the current app, if possible.\n\n  var releaseFile = find(\n    process.cwd(),\n    makeStatTest(\"isFile\"),\n    \".meteor\", \"release\"\n  );\n\n  if (! releaseFile) {\n    return defaultDevBundlePromise;\n  }\n\n  var localDir = path.join(path.dirname(releaseFile), \"local\");\n  if (! statOrNull(localDir, \"isDirectory\")) {\n    try {\n      fs.mkdirSync(localDir);\n    } catch (e) {\n      return defaultDevBundlePromise;\n    }\n  }\n\n  var devBundleLink = path.join(localDir, \"dev_bundle\");\n  var devBundleStat = statOrNull(devBundleLink);\n  if (devBundleStat) {\n    return new Promise(function (resolve) {\n      resolve(links.readLink(devBundleLink));\n    });\n  }\n\n  var release = fs.readFileSync(\n    releaseFile, \"utf8\"\n  ).replace(/^\\s+|\\s+$/g, \"\");\n\n  if (! /^METEOR@\\d+/.test(release)) {\n    return defaultDevBundlePromise;\n  }\n\n  return Promise.resolve(\n    getDevBundleForRelease(release)\n  ).then(function (devBundleDir) {\n    if (devBundleDir) {\n      links.makeLink(devBundleDir, devBundleLink);\n      return devBundleDir;\n    }\n\n    return defaultDevBundlePromise;\n  });\n}\n\nfunction getDevBundleForRelease(release) {\n  var parts = release.split(\"@\");\n  if (parts.length < 2) {\n    return null;\n  }\n\n  var track = parts[0];\n  var version = parts.slice(1).join(\"@\");\n\n  var packageMetadataDir = find(\n    rootDir,\n    makeStatTest(\"isDirectory\"),\n    \".meteor\", \"package-metadata\"\n  );\n\n  if (! packageMetadataDir) {\n    return null;\n  }\n\n  var meteorToolDir = path.resolve(\n    packageMetadataDir,\n    \"..\", \"packages\", \"meteor-tool\"\n  );\n\n  var meteorToolStat = statOrNull(meteorToolDir, \"isDirectory\");\n  if (! meteorToolStat) {\n    return null;\n  }\n\n  var dbPath = path.join(\n    packageMetadataDir,\n    \"v2.0.1\",\n    \"packages.data.db\"\n  );\n\n  var dbStat = statOrNull(dbPath, \"isFile\");\n  if (! dbStat) {\n    return null;\n  }\n\n  var sqlite3 = require(\"sqlite3\");\n  var db = new sqlite3.Database(dbPath);\n\n  return new Promise(function (resolve, reject) {\n    db.get(\n      \"SELECT content FROM releaseVersions WHERE track=? AND version=?\",\n      [track, version],\n      function (error, data) {\n        error ? reject(error) : resolve(data);\n      }\n    );\n\n  }).then(function (data) {\n    if (data) {\n      var tool = JSON.parse(data.content).tool;\n      var devBundleDir = path.join(\n        meteorToolDir,\n        tool.split(\"@\").slice(1).join(\"@\"),\n        \"mt-\" + getHostArch(),\n        \"dev_bundle\"\n      );\n\n      var devBundleStat = statOrNull(devBundleDir, \"isDirectory\");\n      if (devBundleStat) {\n        return devBundleDir;\n      }\n    }\n\n    return null;\n\n  }).catch(function (error) {\n    console.error(error.stack || error);\n    return null;\n  });\n}\n\nfunction statOrNull(path, statMethod) {\n  try {\n    var stat = fs.statSync(path);\n  } catch (e) {\n    if (e.code !== \"ENOENT\") {\n      throw e;\n    }\n  }\n\n  if (stat) {\n    if (typeof statMethod === \"string\") {\n      if (stat[statMethod]()) {\n        return stat;\n      }\n    } else {\n      return stat;\n    }\n  }\n\n  return null;\n}\n\nfunction find(dir, predicate) {\n  var joinArgs = Array.prototype.slice.call(arguments, 2);\n  joinArgs.unshift(null);\n\n  while (true) {\n    joinArgs[0] = dir;\n    var joined = path.join.apply(path, joinArgs);\n    if (predicate(joined)) {\n      return joined;\n    }\n\n    var parentDir = path.dirname(dir);\n    if (parentDir === dir) break;\n    dir = parentDir;\n  }\n\n  return null;\n}\n\nfunction makeStatTest(method) {\n  return function (file) {\n    return statOrNull(file, method);\n  };\n}\n\nfunction getHostArch() {\n  if (process.platform === \"win32\") {\n    return \"os.windows.x86_32\";\n  }\n\n  if (process.platform === \"linux\") {\n    if (process.arch === \"x64\") {\n      return \"os.linux.x86_64\";\n    }\n    return \"os.linux.x86_32\";\n  }\n\n  if (process.platform === \"darwin\") {\n    return \"os.osx.x86_64\";\n  }\n}\n\nmodule.exports = getDevBundleDir().catch(function (error) {\n  return defaultDevBundlePromise;\n});\n"]}