{"version":3,"sources":["/tools/packaging/catalog/catalog.js"],"names":["_","require","remoteCatalog","Console","buildmessage","catalog","exports","refreshFailed","undefined","triedToRefreshRecently","Refresh","OnceAtStart","options","self","extend","prototype","beforeCommand","refreshOrWarn","ignoreErrors","debug","printError","refreshError","error","ExitWithCode","Never","official","refresh","err","errorType","warn","url","isDebugEnabled","runAndRetryWithRefreshIfHelpful","attempt","assertInJob","canRetry","offline","messages","capture","hasMessages","hasMessageWithTag","mergeMessagesIntoCurrentJob","enterJob","message","ACCEPT_NON_EMPTY","result","length","LayeredCatalog","localCatalog","otherCatalog","toString","getLatestVersion","args","_returnFirst","getAllPackageNames","union","f","validityOracle","getPackage","getSortedVersions","getSortedVersionRecords","getVersion","name","version","test","getLatestMainlineVersion","versions","reverse","latest","find","DEFAULT_TRACK"],"mappings":"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","file":"tools/packaging/catalog/catalog.js.map","sourcesContent":["var _ = require('underscore');\nvar remoteCatalog = require('./catalog-remote.js');\nvar Console = require('../../console/console.js').Console;\nvar buildmessage = require('../../utils/buildmessage.js');\n\nvar catalog = exports;\n\ncatalog.refreshFailed = undefined;\ncatalog.triedToRefreshRecently = false;\n\ncatalog.Refresh = {};\n\n// Refresh strategy: once at program start\ncatalog.Refresh.OnceAtStart = function (options) {\n  var self = this;\n  self.options = _.extend({}, options);\n};\n\ncatalog.Refresh.OnceAtStart.prototype.beforeCommand = function () {\n  var self = this;\n  if (!catalog.refreshOrWarn(self.options)) {\n    if (self.options.ignoreErrors) {\n      Console.debug(\"Failed to update package catalog, but will continue.\");\n    } else {\n      Console.printError(catalog.refreshError);\n      Console.error(\"This command requires an up-to-date package catalog.  Exiting.\");\n      // Avoid circular dependency.\n      throw new (require('../../cli/main.js').ExitWithCode)(1);\n    }\n  }\n};\n\n// Refresh strategy: never (we don't use the package catalog)\ncatalog.Refresh.Never = function (options) {\n  var self = this;\n  self.options = _.extend({}, options);\n};\n\n// Refreshes the catalog. Returns true on success.\n// On network error, warns and returns false.\n// Throws other errors (ie, programming errors in the tool).\n//\n// THIS IS A HIGH-LEVEL UI COMMAND. DO NOT CALL IT FROM LOW-LEVEL CODE (ie, call\n// it only from main.js or command implementations).\ncatalog.refreshOrWarn = function (options) {\n  catalog.triedToRefreshRecently = true;\n  try {\n    catalog.official.refresh(options);\n    catalog.refreshFailed = false;\n    return true;\n  } catch (err) {\n    // Example errors:\n\n    // Offline, with name-based host:\n    //   Network error: ws://packages.meteor.com/websocket: getaddrinfo ENOTFOUND\n\n    // Offline, with IP-based host:\n    //   Network error: ws://8.8.8.8/websocket: connect ENETUNREACH\n\n    // Online, bad port:\n    //    Network error: wss://packages.meteor.com:8888/websocket: connect ECONNREFUSED\n\n    // Online, socket hangup:\n    //   Network error: wss://packages.meteor.com:80/websocket: socket hang up\n\n    if (err.errorType !== 'DDP.ConnectionError')\n      throw err;\n\n    // XXX is throwing correct for SQLite errors too? probably.\n\n    Console.warn(\"Unable to update package catalog (are you offline?)\");\n    Console.warn();\n    Console.warn(\n      \"If you are using Meteor behind a proxy, set HTTP_PROXY and HTTPS_PROXY environment variables or see this page for more details: \",\n      Console.url(\"https://github.com/meteor/meteor/wiki/Using-Meteor-behind-a-proxy\"));\n\n    // XXX: Make this Console.debug(err)\n    if (Console.isDebugEnabled()) {\n      Console.printError(err);\n    }\n\n    Console.warn();\n\n    catalog.refreshFailed = true;\n    catalog.refreshError = err;\n    return false;\n  }\n};\n\n// Runs 'attempt'; if it fails in a way that can be fixed by refreshing the\n// official catalog, does that and tries again.\ncatalog.runAndRetryWithRefreshIfHelpful = function (attempt) {\n  buildmessage.assertInJob();\n\n  var canRetry = ! (catalog.triedToRefreshRecently ||\n                    catalog.official.offline);\n\n  // Run `attempt` in a nested buildmessage context.\n  var messages = buildmessage.capture(function () {\n    attempt(canRetry);\n  });\n\n  // Did it work? Great.\n  if (! messages.hasMessages()) {\n    return;\n  }\n\n  // Is refreshing unlikely to be useful, either because the error wasn't\n  // related to that, or because we tried to refresh recently, or because we're\n  // not allowed to refresh? Fail, merging the result of these errors into the\n  // current job.\n  if (! (messages.hasMessageWithTag('refreshCouldHelp') && canRetry)) {\n    buildmessage.mergeMessagesIntoCurrentJob(messages);\n    return;\n  }\n\n  // Refresh!\n  // XXX This is a little hacky, as it shares a bunch of code with\n  // catalog.refreshOrWarn, which is a higher-level function that's allowed to\n  // log.\n  catalog.triedToRefreshRecently = true;\n  try {\n    catalog.official.refresh();\n    catalog.refreshFailed = false;\n  } catch (err) {\n    if (err.errorType !== 'DDP.ConnectionError')\n      throw err;\n    // First place the previous errors in the capture.\n    buildmessage.mergeMessagesIntoCurrentJob(messages);\n    // Then put an error representing this DDP error.\n    buildmessage.enterJob(\n      \"refreshing package catalog to resolve previous errors\",\n      function () {\n        buildmessage.error(err.message);\n      }\n    );\n    return;\n  }\n\n  // Try again, this time directly in the current buildmessage job.\n  attempt(false); // canRetry = false\n};\n\n// As a work-around for [] !== [], we use a function to check whether values are acceptable\nvar ACCEPT_NON_EMPTY = function (result) {\n  // null, undefined\n  if (result === null || result === undefined) {\n    return false;\n  }\n  // []\n  if (result.length === 0) {\n    return false;\n  }\n  return true;\n};\n\n// The LayeredCatalog provides a way to query multiple catalogs in a uniform way\n// A LayeredCatalog contains:\n//  - a local catalog referencing the packages of the project\n//  - a reference to the official catalog\nvar LayeredCatalog = function (localCatalog, otherCatalog) {\n  var self = this;\n\n  self.localCatalog = localCatalog;\n  self.otherCatalog = otherCatalog;\n};\n\n_.extend(LayeredCatalog.prototype, {\n  toString: function () {\n    var self = this;\n    return \"LayeredCatalog []\";\n  },\n\n  getLatestVersion: function (...args) {\n    var self = this;\n    return self._returnFirst(\"getLatestVersion\", args, ACCEPT_NON_EMPTY);\n  },\n\n  getAllPackageNames: function () {\n    var self = this;\n    return _.union(self.localCatalog.getAllPackageNames(), self.otherCatalog.getAllPackageNames());\n  },\n\n  _returnFirst: function(f, args, validityOracle) {\n    var self = this;\n    var result = self.localCatalog[f](...args);\n    if (validityOracle(result)) {\n      return result;\n    }\n    return self.otherCatalog[f](...args);\n  },\n\n  getPackage: function (...args) {\n    return this._returnFirst(\"getPackage\", args, ACCEPT_NON_EMPTY);\n  },\n\n  getSortedVersions: function (...args) {\n    return this._returnFirst(\"getSortedVersions\", args, ACCEPT_NON_EMPTY);\n  },\n\n  getSortedVersionRecords: function (...args) {\n    return this._returnFirst(\n      \"getSortedVersionRecords\", args, ACCEPT_NON_EMPTY);\n  },\n\n  getVersion: function (name, version) {\n    var self = this;\n    var result = self.localCatalog.getVersion(name, version);\n    if (!result) {\n      if (/\\+/.test(version)) {\n        return null;\n      }\n      result = self.otherCatalog.getVersion(name, version);\n    }\n    return result;\n  },\n\n  // As getVersion, but returns info on the latest version of the\n  // package, or null if the package doesn't exist or has no versions.\n  // It does not include prereleases (with dashes in the version);\n  getLatestMainlineVersion: function (name) {\n    var self = this;\n\n    var versions = self.getSortedVersions(name);\n    versions.reverse();\n    var latest = _.find(versions, function (version) {\n      return !/-/.test(version);\n    });\n    if (!latest)\n      return null;\n    return self.getVersion(name, latest);\n  }\n});\n\nexports.DEFAULT_TRACK = remoteCatalog.DEFAULT_TRACK;\nexports.official = remoteCatalog.official;\n\n// This is the catalog that's used to actually drive the constraint solver: it\n// contains local packages, and since local packages always beat server\n// packages, it doesn't contain any information about the server version of\n// local packages.\nexports.LayeredCatalog = LayeredCatalog;\n"]}