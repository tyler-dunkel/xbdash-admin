{"version":3,"sources":["/tools/utils/http-helpers.js"],"names":["os","require","util","_","files","auth","config","release","Console","timeoutScaleFactor","Writable","ConcatStream","chunks","size","_write","chunk","encoding","next","push","length","getBuffer","Buffer","concat","end","force","WritableWithProgress","writable","listener","self","_inner","_listener","extend","prototype","write","callback","_progress","n","done","state","_state","current","progress","reportProgress","on","name","once","arguments","emit","getUserAgent","version","isCheckout","inCheckout","getToolsVersion","format","platform","type","arch","httpHelpers","exports","request","urlOrOptions","options","isObject","url","clone","outputStream","has","bodyStream","bodyStreamLength","responseLength","Error","headers","forceSSL","process","env","CAFILE","ca","readFile","followRedirect","useSessionHeader","useAuthHeader","sessionHeader","getSessionId","getAccountsDomain","authHeader","getSessionToken","promise","Promise","resolve","reject","err","response","body","setCookie","each","h","match","setSessionId","proxy","HTTP_PROXY","http_proxy","test","HTTPS_PROXY","https_proxy","timeout","onRequest","debug","method","req","error","contentLength","Number","call","isFunction","totalProgress","dest","pipe","_addProgressEvents","await","reportProgressDone","emitProgress","undefined","data","getUrl","result","e","OfflineError","href","statusCode","getUrlWithResuming","maxAttempts","retryDelaySecs","masterProgress","attempt","triesRemaining","startAt","Range","addChildTask","title","_title","useTry","change","setTimeout","then"],"mappings":"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","file":"tools/utils/http-helpers.js.map","sourcesContent":["///\n/// utility functions for dealing with urls and http\n///\n\nvar os = require('os');\nvar util = require('util');\n\nvar _ = require('underscore');\n\nvar files = require('../fs/files.js');\nvar auth = require('../meteor-services/auth.js');\nvar config = require('../meteor-services/config.js');\nvar release = require('../packaging/release.js');\nvar Console = require('../console/console.js').Console;\nvar timeoutScaleFactor = require('./utils.js').timeoutScaleFactor;\n\nimport { Writable } from \"stream\";\n\nclass ConcatStream extends Writable {\n  constructor() {\n    super();\n    this.chunks = [];\n    this.size = 0;\n  }\n\n  _write(chunk, encoding, next) {\n    this.chunks.push(chunk);\n    this.size += chunk.length;\n    next();\n  }\n\n  getBuffer() {\n    if (this.chunks.length !== 1) {\n      this.chunks[0] = Buffer.concat(this.chunks);\n      this.chunks.length = 1;\n    }\n\n    return this.chunks[0];\n  }\n\n  end(force = false) {\n    // Override the Writable#end method to ignore any .end() calls for\n    // this stream, since we likely want to resume the download later.\n    if (force === true) {\n      super.end();\n    }\n  }\n}\n\n// Helper that tracks bytes written to a writable\nvar WritableWithProgress = function (writable, listener) {\n  var self = this;\n  self._inner = writable;\n  self._listener = listener;\n};\n\n_.extend(WritableWithProgress.prototype, {\n  write: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk.length, false);\n    return self._inner.write(chunk, encoding);\n  },\n\n  end: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk ? chunk.length : 0, true);\n    return self._inner.end(chunk, encoding);\n  },\n\n  _progress: function (n, done) {\n    var self = this;\n\n    var state = self._state;\n    state.current += n;\n    if (done) {\n      state.current.done = true;\n    }\n    self.progress.reportProgress(state);\n  },\n\n  on: function (name, callback) {\n    return this._inner.on(name, callback);\n  },\n\n  once: function () {\n    return this._inner.once(...arguments);\n  },\n\n  emit: function () {\n    return this._inner.emit(...arguments);\n  }\n});\n\n\n// Compose a User-Agent header.\nvar getUserAgent = function () {\n  var version;\n\n  if (release.current) {\n    version = release.current.isCheckout() ? 'checkout' : release.current.name;\n  } else {\n    // This happens when we haven't finished starting up yet (say, the\n    // user passed --release 1.2.3 and we have to download 1.2.3\n    // before we can get going), or if we are using an installed copy\n    // of Meteor to 'meteor update'ing a project that was created by a\n    // checkout and doesn't have a version yet.\n    version = files.inCheckout() ? 'checkout' : files.getToolsVersion();\n  }\n\n  return util.format('Meteor/%s OS/%s (%s; %s; %s;)', version,\n                     os.platform(), os.type(), os.release(), os.arch());\n};\n\n\nvar httpHelpers = exports;\n_.extend(exports, {\n  getUserAgent: getUserAgent,\n\n  // A wrapper around request with the following improvements:\n  //\n  // - It will respect proxy environment variables if present\n  //   (HTTP_PROXY or HTTPS_PROXY as appropriate).\n  //\n  // - It will set a reasonable User-Agent header.\n  //\n  // - If you omit the callback it will run synchronously. The return\n  //   value will be an object with keys 'response' and 'body' (with\n  //   the same meaning as the arguments to request's normal\n  //   callback), or it will throw.\n  //\n  // - If Set-Cookie headers are present on the response, *and* you\n  //   are using a callback, it will parse the cookies and include\n  //   them as a setCookie attribute on the object passed to the\n  //   callback. setCookie is a simple map from cookie name to cookie\n  //   value. If you want expiration time and attributes you'll have\n  //   to parse it yourself. If there are multiple Set-Cookie headers\n  //   for the same cookie it is unspecified which one you'll get.\n  //\n  // - You can provide a 'bodyStream' option which is a stream that\n  //   will be used for the body of the request.\n  //\n  // - For authenticated MDG services, you can set the\n  //   'useSessionHeader' and/or 'useAuthHeader' options (to true) to\n  //   send X-Meteor-Session/X-Meteor-Auth headers using values from\n  //   the session file.\n  //\n  // - forceSSL is always set to true. Always. And followRedirect is\n  //   set to false since it doesn't understand origins (see comment\n  //   in implementation).\n  //\n  // - An optional options.onRequest callback may be provided if the\n  //   caller desires access to the request object.\n  //\n  // NB: With useSessionHeader and useAuthHeader, this function will\n  // read *and possibly write to* the session file, so if you are\n  // writing auth code (in auth.js) and you call it, be sure to reread\n  // the session file afterwards.\n  request: function (urlOrOptions, callback) {\n    var options;\n    if (!_.isObject(urlOrOptions)) {\n      options = { url: urlOrOptions };\n    } else {\n      options = _.clone(urlOrOptions);\n    }\n\n    var outputStream;\n    if (_.has(options, 'outputStream')) {\n      outputStream = options.outputStream;\n      delete options.outputStream;\n    }\n\n    var bodyStream;\n    if (_.has(options, 'bodyStream')) {\n      bodyStream = options.bodyStream;\n      delete options.bodyStream;\n    }\n\n    // Body stream length for progress\n    var bodyStreamLength = 0;\n    if (_.has(options, 'bodyStreamLength')) {\n      bodyStreamLength = options.bodyStreamLength;\n      delete options.bodyStreamLength;\n    } else {\n      // Guess the body stream length as 1MB\n      // Hopefully if it's much bigger the caller will set it\n      // If it is much small, we will pleasantly surprise the user!\n      if (bodyStream) {\n        bodyStreamLength = 1024 * 1024;\n      }\n    }\n\n    // Response length for progress\n    var responseLength = 128 * 1024;\n    if (_.has(options, 'responseLength')) {\n      responseLength = options.responseLength;\n      delete options.responseLength;\n    }\n\n    var progress = null;\n    if (_.has(options, 'progress')) {\n      progress = options.progress;\n      delete options.progress;\n\n      if (callback) {\n        throw new Error(\"Not safe to use progress with callback\");\n      }\n    }\n\n    options.headers = _.extend({\n      'User-Agent': getUserAgent()\n    }, options.headers || {});\n\n    // This should never, ever be false, or else why are you using SSL?\n    options.forceSSL = true;\n    if (process.env.CAFILE) {\n      options.ca = files.readFile(process.env.CAFILE);\n    }\n\n    // followRedirect is very dangerous because request does not\n    // appear to segregate cookies by origin, so any cookies (and\n    // apparently headers as well, eg X-Meteor-Auth) sent on the\n    // original request could get forwarded to an unexpected domain in\n    // a redirect. This is almost certainly not something you ever\n    // want.\n    options.followRedirect = false;\n\n    var useSessionHeader = options.useSessionHeader;\n    delete options.useSessionHeader;\n    var useAuthHeader = options.useAuthHeader;\n    delete options.useAuthHeader;\n    if (useSessionHeader || useAuthHeader) {\n      var sessionHeader = auth.getSessionId(config.getAccountsDomain());\n      if (sessionHeader) {\n        options.headers['X-Meteor-Session'] = sessionHeader;\n      }\n      if (callback) {\n        throw new Error(\"session header can't be used with callback\");\n      }\n    }\n    if (useAuthHeader) {\n      var authHeader = auth.getSessionToken(config.getAccountsDomain());\n      if (authHeader) {\n        options.headers['X-Meteor-Auth'] = authHeader;\n      }\n    }\n\n    var promise;\n    if (! callback) {\n      promise = new Promise(function (resolve, reject) {\n        callback = function (err, response, body) {\n          if (err) {\n            reject(err);\n            return;\n          }\n\n          var setCookie = {};\n          _.each(response.headers[\"set-cookie\"] || [], function (h) {\n            var match = h.match(/^([^=\\s]+)=([^;\\s]+)/);\n            if (match) {\n              setCookie[match[1]] = match[2];\n            }\n          });\n\n          if (useSessionHeader && _.has(response.headers, \"x-meteor-session\")) {\n            auth.setSessionId(config.getAccountsDomain(),\n                              response.headers['x-meteor-session']);\n          }\n\n          resolve({\n            response: response,\n            body: body,\n            setCookie: setCookie\n          });\n        };\n      });\n    }\n\n    // try to get proxy from environment.\n    // similar code is in packages/ddp/stream_client_nodejs.js\n    var proxy = process.env.HTTP_PROXY || process.env.http_proxy || null;\n    // if we're going to an https url, try the https_proxy env variable first.\n    if (/^https/i.test(options.url)) {\n      proxy = process.env.HTTPS_PROXY || process.env.https_proxy || proxy;\n    }\n    if (proxy && !options.proxy) {\n      options.proxy = proxy;\n    }\n\n    if (! _.has(options, \"timeout\")) {\n      // 60 seconds for timeout between initial response headers and data,\n      // and between chunks of data while reading the rest of the response.\n      options.timeout = 60 * 1000 * timeoutScaleFactor;\n    } else if (! (typeof options.timeout === \"number\" &&\n                  options.timeout > 0)) {\n      // The timeout can be disabled by passing anything other than a\n      // positive number, e.g. { timeout: null }.\n      delete options.timeout;\n    }\n\n    let onRequest;\n    if (_.has(options, \"onRequest\")) {\n      onRequest = options.onRequest;\n      delete options.onRequest;\n    }\n\n    // request is the most heavy-weight of the tool's npm dependencies; don't\n    // require it until we definitely need it.\n    Console.debug(\"Doing HTTP request: \", options.method || 'GET', options.url);\n    var request = require('request');\n    var req = request(options, function (error, response, body) {\n      if (! error && response && body) {\n        const contentLength = Number(response.headers[\"content-length\"]);\n        if (contentLength > 0 && body.length < contentLength) {\n          error = new Error(\n            \"Expected \" + contentLength + \" bytes in request body \" +\n              \"but received only \" + body.length);\n        }\n      }\n      return callback.call(this, error, response, body);\n    });\n\n    if (_.isFunction(onRequest)) {\n      onRequest(req);\n    }\n\n    var totalProgress = { current: 0, end: bodyStreamLength + responseLength, done: false };\n\n    if (bodyStream) {\n      var dest = req;\n      if (progress) {\n        dest = new WritableWithProgress(dest, function (n, done) {\n          if (!totalProgress.done) {\n            totalProgress.current += n;\n            progress.reportProgress(totalProgress);\n          }\n        });\n      }\n      bodyStream.pipe(dest);\n    }\n\n    if (outputStream) {\n      req.pipe(outputStream);\n    }\n\n    if (progress) {\n      httpHelpers._addProgressEvents(req);\n      req.on('progress', function (state) {\n        if (!totalProgress.done) {\n          totalProgress.current = bodyStreamLength + state.current;\n          totalProgress.end = bodyStreamLength + state.end;\n          totalProgress.done = state.done;\n\n          progress.reportProgress(totalProgress);\n        }\n      });\n    }\n\n    if (promise) {\n      try {\n        return promise.await();\n      } finally {\n        if (progress) {\n          progress.reportProgressDone();\n        }\n      }\n    } else {\n      return req;\n    }\n  },\n\n  // Adds progress callbacks to a request\n  // Based on request-progress\n  _addProgressEvents: function (request) {\n    var state = {};\n\n    var emitProgress = function () {\n      request.emit('progress', state);\n    };\n\n    request\n      .on('response', function (response) {\n        state.end = undefined;\n        state.done = false;\n        state.current = 0;\n        var contentLength = response.headers['content-length'];\n        if (contentLength) {\n          state.end = Number(contentLength);\n        }\n        emitProgress();\n      })\n      .on('data', function (data) {\n        state.current += data.length;\n        emitProgress();\n      })\n      .on('end', function (data) {\n        state.done = true;\n        emitProgress();\n      });\n  },\n\n  // A synchronous wrapper around request(...) that returns the response \"body\"\n  // or throws.\n  //\n  // (This has gone through a few refactors and it might be possible\n  // to fully roll it into httpHelpers.request() at this point.)\n  getUrl: function (urlOrOptions) {\n    try {\n      var result = httpHelpers.request(urlOrOptions);\n    } catch (e) {\n      throw new files.OfflineError(e);\n    }\n\n    const response = result.response;\n    const body = result.body;\n    const href = response.request.href;\n\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      throw Error(\n        body ||\n          `Could not get ${href}; server returned [${response.statusCode}]`);\n    } else {\n      return body;\n    }\n  },\n\n  // More or less as above, except with support for multiple attempts per\n  // request and resuming on retries. This means if the connection is bad,\n  // we can sometimes complete a request, even if each individual attempt fails.\n  // We only use this for package downloads. In theory we could use it for\n  // all requests but that seems like overkill and it isn't well tested in\n  // other scenarioes.\n  getUrlWithResuming(urlOrOptions) {\n    const options = _.isObject(urlOrOptions) ? _.clone(urlOrOptions) : {\n      url: urlOrOptions,\n    };\n\n    const maxAttempts =\n      _.has(options, \"maxAttempts\")\n      ? options.maxAttempts : 10;\n\n    const retryDelaySecs =\n      _.has(options, \"retryDelaySecs\")\n      ? options.retryDelaySecs : 5;\n\n    const masterProgress = options.progress;\n    const outputStream = new ConcatStream();\n\n    function attempt(triesRemaining = maxAttempts, startAt = 0) {\n      if (startAt > 0) {\n        options.headers = {\n          ...options.headers,\n          Range: `bytes=${startAt}-`\n        };\n      }\n\n      if (masterProgress &&\n          masterProgress.addChildTask) {\n        options.progress = masterProgress.addChildTask({\n          title: masterProgress._title\n        });\n      }\n\n      try {\n        return Promise.resolve(httpHelpers.request({\n          outputStream,\n          ...options,\n        }));\n\n      } catch (e) {\n        const size = outputStream.size;\n        const useTry = size === startAt;\n        const change = size - startAt;\n\n        if (!useTry || triesRemaining > 0) {\n          if (useTry) {\n            Console.debug(`Request failed, ${triesRemaining - 1} attempts left`);\n          } else {\n            Console.debug(`Request failed after ${change} bytes, retrying`);\n          }\n\n          return new Promise(\n            resolve => setTimeout(resolve, retryDelaySecs * 1000)\n          ).then(() => attempt(triesRemaining - (useTry ? 1 : 0), size));\n        }\n\n        Console.debug(`Request failed ${maxAttempts} times: failing`);\n        return Promise.reject(new files.OfflineError(e));\n      }\n    }\n\n    const result = attempt().await();\n    const response = result.response\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      const href = response.request.href;\n      throw Error(`Could not get ${href}; server returned [${response.statusCode}]`);\n    }\n\n    // Really end the stream if we got this far.\n    outputStream.end(true);\n\n    return outputStream.getBuffer();\n  }\n});\n"]}