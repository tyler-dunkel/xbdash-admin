{"version":3,"sources":["/tools/tool-env/install-git-hooks.js"],"names":["files","hookDestination","pathJoin","getCurrentToolsDir","hookSource","allPossibleHooks","METEOR_HOOK_SUFFIX","METEOR_HOOK_LINE_REGEX","installGitHooks","exists","map","hookName","hookFile","sourceFile","meteorHookFile","removeMeteorInjectedHook","METEOR_HOOK_INJECTED_LINE","writeFile","encoding","mode","readFile","appendFile","unlink","err","code","replace"],"mappings":"AAAA,OAAOA,KAAP,MAAkB,gBAAlB;;AAEA,IAAMC,kBACJD,MAAME,QAAN,CAAeF,MAAMG,kBAAN,EAAf,EAA2C,MAA3C,EAAmD,OAAnD,CADF;;AAGA,IAAMC,aACJJ,MAAME,QAAN,CAAeF,MAAMG,kBAAN,EAAf,EACE,SADF,EACa,OADb,EACsB,WADtB,CADF;;AAIA,IAAME,mBAAmB,CACvB,gBADuB,EAEvB,gBAFuB,EAGvB,iBAHuB,EAIvB,YAJuB,EAKvB,oBALuB,EAMvB,YANuB,EAOvB,aAPuB,EAQvB,YARuB,EASvB,eATuB,EAUvB,YAVuB,EAWvB,aAXuB,EAYvB,QAZuB,EAavB,aAbuB,EAcvB,aAduB,EAevB,cAfuB,CAAzB;;AAkBA;AACA,IAAMC,qBAAqB,cAA3B;;AAEA;AACA,IAAMC,yBAAyB,iBAA/B;;AAEA,eAAe,SAASC,eAAT,GAA2B;;AAExC,MAAI,CAACR,MAAMS,MAAN,CAAaR,eAAb,CAAL,EAAoC;AAClC;AACA;AACA;AACD;;AAEDI,mBAAiBK,GAAjB,CAAqB,UAACC,QAAD,EAAc;AACjC,QAAMC,WAAWZ,MAAME,QAAN,CAAeD,eAAf,EAAgCU,QAAhC,CAAjB;AACA,QAAME,aAAab,MAAME,QAAN,CAAeE,UAAf,EAA2BO,QAA3B,CAAnB;AACA,QAAMG,iBAAiBF,WAAWN,kBAAlC;;AAEA,QAAI,CAACN,MAAMS,MAAN,CAAaI,UAAb,CAAD,IAA6B,CAACb,MAAMS,MAAN,CAAaG,QAAb,CAAlC,EAA0D;AACxD;AACA;AACD;;AAED,QAAI,CAACZ,MAAMS,MAAN,CAAaI,UAAb,CAAL,EAA+B;AAC7B;AACA;AACAE,+BAAyBH,QAAzB;AACA;AACD;;AAED;AACA,QAAMI,qDAAmDL,QAAnD,GAA8DL,kBAA9D,kCAAN;AACA;;AAEA,QAAI,CAACN,MAAMS,MAAN,CAAaG,QAAb,CAAL,EAA6B;AAC3B;AACA;AACAZ,YAAMiB,SAAN,CAAgBL,QAAhB,kBAEJI,yBAFI,EAGE,EAAEE,UAAU,MAAZ,EAAoBC,MAAM,GAA1B,EAHF;;AAKA;AACAnB,YAAMiB,SAAN,CAAgBH,cAAhB,EAAgCd,MAAMoB,QAAN,CAAeP,UAAf,CAAhC,EACE,EAAEM,MAAM,GAAR,EADF;AAEA;AACD;;AAED;;AAEA;AACA,QAAI,CAACnB,MAAMS,MAAN,CAAaK,cAAb,CAAL,EAAmC;AACjCd,YAAMqB,UAAN,CAAiBT,QAAjB,EAA2BI,yBAA3B;AACD;;AAED;AACAhB,UAAMiB,SAAN,CAAgBH,cAAhB,EAAgCd,MAAMoB,QAAN,CAAeP,UAAf,CAAhC,EACE,EAAEM,MAAM,GAAR,EADF;AAEA;AACD,GA9CD;AA+CD;;AAED,SAASJ,wBAAT,CAAkCH,QAAlC,EAA4C;AAC1C;AACA,MAAI;AACFZ,UAAMsB,MAAN,CAAaV,WAAWN,kBAAxB;AACD,GAFD,CAEE,OAAOiB,GAAP,EAAY;AACZ;AACA,QAAIA,IAAIC,IAAJ,KAAa,QAAjB,EAA2B;AACzB,YAAMD,GAAN;AACD;AACF;;AAED;AACAvB,QAAMiB,SAAN,CAAgBL,QAAhB,EACEZ,MAAMoB,QAAN,CAAeR,QAAf,EAAyB,MAAzB,EAAiCa,OAAjC,CAAyClB,sBAAzC,EAAiE,EAAjE,CADF,EAEE,MAFF;AAGD","file":"tools/tool-env/install-git-hooks.js.map","sourcesContent":["import files from '../fs/files.js';\n\nconst hookDestination =\n  files.pathJoin(files.getCurrentToolsDir(), '.git', 'hooks');\n\nconst hookSource =\n  files.pathJoin(files.getCurrentToolsDir(),\n    'scripts', 'admin', 'git-hooks');\n\nconst allPossibleHooks = [\n  'applypatch-msg',\n  'pre-applypatch',\n  'post-applypatch',\n  'pre-commit',\n  'prepare-commit-msg',\n  'commit-msg',\n  'post-commit',\n  'pre-rebase',\n  'post-checkout',\n  'post-merge',\n  'pre-receive',\n  'update',\n  'post-update',\n  'pre-auto-gc',\n  'post-rewrite',\n];\n\n// A suffix that we append to our hook scripts\nconst METEOR_HOOK_SUFFIX = '.meteor-hook';\n\n// Matches the whole line we inject into the user's hook\nconst METEOR_HOOK_LINE_REGEX = /.*meteor-hook.*/;\n\nexport default function installGitHooks() {\n\n  if (!files.exists(hookDestination)) {\n    // Don't do anything if the hook destination does not exist, eg.,\n    // we are not running from a git clone.\n    return;\n  }\n\n  allPossibleHooks.map((hookName) => {\n    const hookFile = files.pathJoin(hookDestination, hookName);\n    const sourceFile = files.pathJoin(hookSource, hookName);\n    const meteorHookFile = hookFile + METEOR_HOOK_SUFFIX;\n\n    if (!files.exists(sourceFile) && !files.exists(hookFile)) {\n      // Don't do anything if this hook isn't in either list\n      return;\n    }\n\n    if (!files.exists(sourceFile)) {\n      // If the user has this hook, but Meteor doesn't, make sure that we remove\n      // any hooks that we added previously\n      removeMeteorInjectedHook(hookFile);\n      return;\n    }\n\n    /* eslint-disable max-len */\n    const METEOR_HOOK_INJECTED_LINE = `exec \"$(dirname $0)/${hookName}${METEOR_HOOK_SUFFIX}\" # Inserted by Meteor tool\\n`;\n    /* eslint-enable */\n\n    if (!files.exists(hookFile)) {\n      // If the user doesn't have this hook, but we want to add it, just insert\n      // a new file and a line that calls it\n      files.writeFile(hookFile,\n        `#!/bin/sh\n${METEOR_HOOK_INJECTED_LINE}`,\n        { encoding: 'utf8', mode: 0o755 });\n\n      // Copy the hook from the scripts dir\n      files.writeFile(meteorHookFile, files.readFile(sourceFile),\n        { mode: 0o755 });\n      return;\n    }\n\n    // Now we have arrived at the case where the user already has a hook\n\n    // Has Meteor already installed a hook here? If not, add a line to the hook\n    if (!files.exists(meteorHookFile)) {\n      files.appendFile(hookFile, METEOR_HOOK_INJECTED_LINE);\n    }\n\n    // Copy the hook from the scripts dir again in case it updated\n    files.writeFile(meteorHookFile, files.readFile(sourceFile),\n      { mode: 0o755 });\n    return;\n  });\n}\n\nfunction removeMeteorInjectedHook(hookFile) {\n  // Remove the script added by Meteor\n  try {\n    files.unlink(hookFile + METEOR_HOOK_SUFFIX);\n  } catch (err) {\n    // Ignore errors about file not found\n    if (err.code !== 'ENOENT') {\n      throw err;\n    }\n  }\n\n  // Remove the line added to the file\n  files.writeFile(hookFile,\n    files.readFile(hookFile, 'utf8').replace(METEOR_HOOK_LINE_REGEX, ''),\n    'utf8');\n}\n"]}