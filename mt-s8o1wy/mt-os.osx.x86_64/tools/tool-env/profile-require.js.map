{"version":3,"sources":["/tools/tool-env/profile-require.js"],"names":["path","require","now","Date","currentInvocation","RequireInvocation","name","filename","self","timeStarted","timeFinished","parent","children","selfTime","totalTime","prototype","isOurCode","match","ourSource","resolve","__dirname","required","dirname","length","substr","why","walk","last","basename","exports","start","moduleModule","realLoader","_load","args","id","inv","push","apply","printReport","_","computeTimes","childTime","each","child","summary","summarize","depth","time","ours","via","times","sortBy","values","reverse","ourTotal","otherTotal","item","line","toFixed","keys","join","console","log","grandTotal","Error"],"mappings":"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","file":"tools/tool-env/profile-require.js.map","sourcesContent":["// Use path instead of files.js here because we are explicitly trying to\n// track requires, and files.js is often a culprit of slow requires.\nvar path = require('path');\n\n// seconds since epoch\nvar now = function () {\n  return (+ new Date)/1000;\n};\n\nvar currentInvocation;\nvar RequireInvocation = function (name, filename) {\n  var self = this;\n  self.name = name; // module required\n  self.filename = filename; // file doing the requiring, if known\n  self.timeStarted = now();\n  self.timeFinished = null;\n  self.parent = currentInvocation;\n  self.children = []; // array of RequireInvocation\n\n  self.selfTime = null;\n  self.totalTime = null;\n};\n\nRequireInvocation.prototype.isOurCode = function () {\n  var self = this;\n\n  if (! self.filename) {\n    return self.name === 'TOP';\n  }\n\n  if (! self.name.match(/\\//)) {\n    // we always require our stuff via a path\n    return false;\n  }\n\n  var ourSource = path.resolve(__dirname);\n  var required = path.resolve(path.dirname(self.filename), self.name);\n  if (ourSource.length > required.length) {\n    return false;\n  }\n  return required.substr(0, ourSource.length) === ourSource;\n};\n\nRequireInvocation.prototype.why = function () {\n  var self = this;\n  var walk = self;\n  var last = null;\n\n  while (walk && ! walk.isOurCode()) {\n    last = walk;\n    walk = walk.parent;\n  }\n\n  if (! walk) {\n    return \"???\";\n  }\n  if (last) {\n    return path.basename(walk.name) + \":\" + path.basename(last.name);\n  }\n  return path.basename(walk.name);\n};\n\nexports.start = function () {\n  var moduleModule = require('module');\n  currentInvocation = new RequireInvocation('TOP');\n\n  var realLoader = moduleModule._load;\n  moduleModule._load = function (...args) {\n    var [id, { filename }] = args;\n    var inv = new RequireInvocation(id, filename);\n    var parent = currentInvocation;\n    currentInvocation.children.push(inv);\n    currentInvocation = inv;\n\n    try {\n      return realLoader.apply(this, args);\n    } finally {\n      inv.timeFinished = now();\n      currentInvocation = parent;\n    }\n  };\n};\n\nexports.printReport = function () {\n  currentInvocation.timeFinished = now();\n  var _ = require('underscore');\n\n  var computeTimes = function (inv) {\n    inv.totalTime = inv.timeFinished - inv.timeStarted;\n\n    var childTime = 0;\n    _.each(inv.children, function (child) {\n      computeTimes(child);\n      childTime += child.totalTime;\n    });\n\n    if (inv.totalTime !== null) {\n      inv.selfTime = inv.totalTime - childTime;\n    }\n  };\n  computeTimes(currentInvocation);\n\n  var summary = {};\n  var summarize = function (inv, depth) {\n    // var padding = (new Array(depth*2 + 1)).join(' ');\n    // console.log(padding + inv.name + \" [\" + inv.selfTime + \"]\");\n    if (! (inv.name in summary)) {\n      summary[inv.name] = { name: inv.name, time: 0, ours: inv.isOurCode(),\n                            via: {} };\n    }\n    summary[inv.name].time += inv.selfTime;\n    if (! inv.isOurCode()) {\n      summary[inv.name].via[inv.why()] = true;\n    }\n\n    _.each(inv.children, function (inv) {\n      summarize(inv, depth + 1);\n    });\n  };\n  summarize(currentInvocation, 0);\n\n  var times = _.sortBy(_.values(summary), 'time').reverse();\n  var ourTotal = 0, otherTotal = 0;\n  _.each(times, function (item) {\n    var line = (item.time * 1000).toFixed(2) + \" \" + item.name;\n    if (! item.ours) {\n      line += \" [via \" + _.keys(item.via).join(\", \") + \"]\";\n    }\n    console.log(line);\n    if (item.ours) {\n      ourTotal += item.time;\n    } else {\n      otherTotal += item.time;\n    }\n  });\n\n\n  var grandTotal = currentInvocation.totalTime;\n  if (grandTotal - ourTotal - otherTotal > 1/1000) {\n    throw new Error(\"Times don't add up\");\n  }\n  console.log(\"TOTAL: ours \" + (ourTotal * 1000).toFixed(2) +\n              \", other \" + (otherTotal * 1000).toFixed(2) +\n              \", grand total \" + (grandTotal * 1000).toFixed(2));\n};\n"]}